<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Witch's Brew Workshop ğŸ§™â€â™€ï¸</title>
<link href="https://fonts.googleapis.com/css2?family=Creepster&family=Bubblegum+Sans&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0d0a1a;--purple:#6a0dad;--bright:#b44fff;
  --green:#39ff14;--orange:#ff6b1a;--yellow:#ffd700;--text:#e8d5ff;
  --c-common:#aaa;--c-rare:#4488ff;--c-epic:#cc44ff;--c-legendary:#ff9900;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);font-family:'Bubblegum Sans',cursive;color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(1px 1px at 10% 15%,#fff 0%,transparent 100%),
  radial-gradient(1px 1px at 30% 5%,#fff 0%,transparent 100%),
  radial-gradient(2px 2px at 50% 20%,#ffd700 0%,transparent 100%),
  radial-gradient(1px 1px at 70% 8%,#fff 0%,transparent 100%),
  radial-gradient(1px 1px at 85% 25%,#fff 0%,transparent 100%),
  radial-gradient(2px 2px at 20% 40%,#b44fff 0%,transparent 100%),
  radial-gradient(1px 1px at 45% 45%,#fff 0%,transparent 100%),
  radial-gradient(2px 2px at 60% 70%,#ffd700 0%,transparent 100%),
  radial-gradient(1px 1px at 80% 80%,#fff 0%,transparent 100%),
  radial-gradient(2px 2px at 15% 90%,#b44fff 0%,transparent 100%);
  animation:twinkle 3s infinite alternate;}
@keyframes twinkle{0%{opacity:.6}100%{opacity:1}}
.moon{position:fixed;top:20px;right:30px;font-size:4rem;z-index:1;pointer-events:none;filter:drop-shadow(0 0 20px rgba(255,215,0,.6));animation:moon-glow 4s infinite alternate;}
@keyframes moon-glow{from{filter:drop-shadow(0 0 10px rgba(255,215,0,.4))}to{filter:drop-shadow(0 0 30px rgba(255,215,0,.9))}}
.bat{position:fixed;font-size:24px;animation:fly linear infinite;z-index:1;pointer-events:none;}
.bat:nth-child(2){top:10%;animation-duration:8s;}
.bat:nth-child(3){top:25%;animation-duration:12s;animation-delay:-3s;font-size:18px;}
.bat:nth-child(4){top:5%;animation-duration:10s;animation-delay:-6s;}
@keyframes fly{0%{left:-5%;transform:scaleX(1)}49%{transform:scaleX(1)}50%{left:105%;transform:scaleX(-1)}100%{left:-5%;transform:scaleX(-1)}}

/* LAYOUT */
.wrap{position:relative;z-index:2;max-width:960px;margin:0 auto;padding:16px;}
header{text-align:center;padding:16px 0 8px;}
h1{font-family:'Creepster',cursive;font-size:clamp(2rem,6vw,3.5rem);color:var(--bright);text-shadow:0 0 20px var(--purple),0 0 40px var(--purple);letter-spacing:2px;animation:glow 2s infinite alternate;}
@keyframes glow{from{text-shadow:0 0 10px var(--purple)}to{text-shadow:0 0 30px var(--bright),0 0 60px var(--purple)}}
.subtitle{font-size:1rem;color:var(--yellow);margin-top:4px;}

/* HUD */
.hud{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin:10px 0 6px;}
.hb{background:rgba(0,0,0,.4);border:1px solid rgba(180,79,255,.35);border-radius:12px;padding:6px 12px;display:flex;flex-direction:column;align-items:center;min-width:65px;}
.hl{font-size:.58rem;color:#888;letter-spacing:1px;text-transform:uppercase;}
.hv{font-family:'Creepster',cursive;font-size:1.3rem;color:var(--yellow);line-height:1.2;}
.streak-hb.on{border-color:var(--orange);background:rgba(255,107,26,.15);}
.streak-hb.on .hv{color:#ff8844;}
.tries-hb.danger .hv{color:#ff4444;}
.xpbar{background:rgba(255,255,255,.1);border-radius:10px;height:6px;margin:4px 0;overflow:hidden;max-width:400px;margin:4px auto;}
.xpfill{height:100%;background:linear-gradient(90deg,var(--purple),var(--bright));border-radius:10px;transition:width .5s;}
.hint{font-size:.68rem;color:#666;text-align:center;margin-bottom:4px;}

/* GRID */
.main{display:grid;grid-template-columns:1fr auto 1fr;gap:16px;align-items:start;margin-top:12px;}
.panel{background:rgba(106,13,173,.12);border:2px solid var(--purple);border-radius:20px;padding:14px;box-shadow:0 0 20px rgba(106,13,173,.3);}
.ptitle{font-family:'Creepster',cursive;font-size:1.3rem;color:var(--yellow);text-align:center;margin-bottom:10px;}
.igrid{display:grid;grid-template-columns:1fr 1fr;gap:7px;}
.ibtn{background:rgba(255,255,255,.05);border:2px solid transparent;border-radius:14px;padding:9px 5px;cursor:pointer;transition:all .2s;text-align:center;font-family:'Bubblegum Sans',cursive;color:var(--text);}
.ibtn .em{font-size:1.8rem;display:block;margin-bottom:3px;}
.ibtn .nm{display:block;font-size:.72rem;}
.ibtn .tg{display:block;font-size:.6rem;margin-top:2px;padding:1px 5px;border-radius:8px;font-weight:bold;}
.ibtn:hover{transform:scale(1.05);background:rgba(180,79,255,.2);border-color:var(--bright);}
.ibtn:active{transform:scale(.95);}
.ibtn.sel{border-color:var(--green);background:rgba(57,255,20,.1);}
.ibtn.disabled-ing{opacity:.4;pointer-events:none;}
.tag-magic{background:rgba(180,79,255,.4);color:#e0b0ff;}
.tag-nature{background:rgba(57,255,20,.3);color:#80ff50;}
.tag-spooky{background:rgba(255,107,26,.3);color:#ffb080;}
.tag-science{background:rgba(0,200,255,.3);color:#80e8ff;}

/* CAULDRON AREA â€” key: no overflow issues */
.cauldron-area{display:flex;flex-direction:column;align-items:center;gap:12px;min-width:260px;}

/* Flame wrapper sits ABOVE the cauldron wrapper in DOM so it can't overlap buttons */
.flame-row{display:flex;gap:4px;justify-content:center;margin-bottom:-8px;pointer-events:none;}
.flame{width:13px;border-radius:50% 50% 20% 20%;animation:flicker ease-in-out infinite alternate;transform-origin:bottom;}
.flame:nth-child(1){height:30px;background:radial-gradient(ellipse at 50% 80%,#fff 0%,#ffdd00 30%,#ff8800 60%,transparent 100%);animation-duration:.4s;}
.flame:nth-child(2){height:22px;background:radial-gradient(ellipse at 50% 80%,#fff 0%,#ffcc00 30%,#ff5500 60%,transparent 100%);animation-duration:.5s;animation-delay:.1s;}
.flame:nth-child(3){height:34px;background:radial-gradient(ellipse at 50% 80%,#fff 0%,#ffee00 30%,#ff7700 60%,transparent 100%);animation-duration:.35s;animation-delay:.2s;}
.flame:nth-child(4){height:20px;background:radial-gradient(ellipse at 50% 80%,#fff 0%,#ffcc00 30%,#ff4400 60%,transparent 100%);animation-duration:.45s;animation-delay:.05s;}
.flame:nth-child(5){height:28px;background:radial-gradient(ellipse at 50% 80%,#fff 0%,#ffdd00 30%,#ff6600 60%,transparent 100%);animation-duration:.38s;animation-delay:.15s;}
@keyframes flicker{0%{transform:scaleX(1) scaleY(1) rotate(-2deg)}100%{transform:scaleX(.85) scaleY(1.1) rotate(2deg)}}

/* Cauldron wrapper: fixed size, NO overflow, NO isolation */
.cw{position:relative;width:240px;height:240px;}
/* All children of .cw that aren't interactive */
.cw *{pointer-events:none;}
#brew-liquid{transition:fill .8s ease;}

/* Bubbles */
.bub{position:absolute;border-radius:50%;animation:bub-rise linear forwards;pointer-events:none;}
@keyframes bub-rise{0%{transform:translateY(0) scale(.5);opacity:.8}100%{transform:translateY(-55px) scale(1.2);opacity:0}}
.brew-glow{position:absolute;bottom:28px;left:50%;transform:translateX(-50%);width:100px;height:28px;border-radius:50%;filter:blur(14px);transition:all .5s ease;pointer-events:none;}
.steam{position:absolute;top:10px;font-size:1.7rem;animation:steam-rise 2s infinite ease-out;pointer-events:none;}
.steam:nth-child(1){left:35%;animation-delay:0s;}
.steam:nth-child(2){left:55%;animation-delay:.7s;}
.steam:nth-child(3){left:45%;animation-delay:1.4s;font-size:1.2rem;}
@keyframes steam-rise{0%{opacity:.8;transform:translateY(0)}100%{opacity:0;transform:translateY(-50px) scale(1.5)}}

/* Cauldron shake (only on wrapper, won't affect buttons outside) */
@keyframes cshake{0%,100%{transform:rotate(0)}20%{transform:rotate(-4deg)}40%{transform:rotate(4deg)}60%{transform:rotate(-3deg)}80%{transform:rotate(3deg)}}
.cshake{animation:cshake .5s ease;}
@keyframes ctilt{0%,100%{transform:rotate(0) scale(1)}15%{transform:rotate(-7deg) scale(1.04)}30%{transform:rotate(7deg) scale(1.06)}55%{transform:rotate(-4deg) scale(1.03)}75%{transform:rotate(3deg) scale(1.01)}}
.ctilt{animation:ctilt .9s ease;}

/* Cauldron ingredient slots */
.cauldron-slots{display:flex;gap:10px;justify-content:center;align-items:center;margin-bottom:6px;min-height:64px;}
.cslot{width:54px;height:54px;border-radius:50%;border:2px dashed rgba(180,79,255,.35);background:rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;font-size:1.8rem;transition:all .3s cubic-bezier(.34,1.56,.64,1);position:relative;}
.cslot.filled{border-color:var(--green);background:rgba(57,255,20,.12);box-shadow:0 0 12px rgba(57,255,20,.3);transform:scale(1.08);}
.cslot.filled .cslot-em{animation:slotPop .35s cubic-bezier(.34,1.56,.64,1);}
@keyframes slotPop{0%{transform:scale(0) rotate(-30deg)}70%{transform:scale(1.2) rotate(5deg)}100%{transform:scale(1) rotate(0)}}
.cslot-em{display:block;line-height:1;}
.cslot.empty-slot::after{content:'?';color:rgba(180,79,255,.4);font-size:1.4rem;font-family:'Creepster',cursive;}
/* Brew swirl â€” ingredients dissolve into cauldron */
.brew-swirl{position:fixed;pointer-events:none;z-index:200;font-size:1.9rem;will-change:transform,opacity;}
@keyframes swirlIn{
  0%{opacity:1;transform:translate(-50%,-50%) scale(1) rotate(0deg);}
  60%{opacity:.8;transform:translate(-50%,-50%) scale(.6) rotate(270deg);}
  100%{opacity:0;transform:translate(-50%,-50%) scale(0) rotate(540deg);}
}
@keyframes dissolve{
  0%{opacity:1;filter:blur(0);}
  100%{opacity:0;filter:blur(8px) brightness(3);}
}

/* BUTTONS â€” outside cw, no z-index conflicts */
.brew-btn{background:linear-gradient(135deg,#6a0dad,#b44fff);border:none;border-radius:22px;padding:13px 24px;font-family:'Creepster',cursive;font-size:1.35rem;color:#fff;cursor:pointer;transition:all .2s;box-shadow:0 0 20px rgba(180,79,255,.5);width:100%;}
.brew-btn:hover:not(:disabled){transform:scale(1.04);box-shadow:0 0 30px rgba(180,79,255,.8);}
.brew-btn:active:not(:disabled){transform:scale(.97);}
.brew-btn:disabled{opacity:.4;cursor:not-allowed;}
.clr-btn{background:transparent;border:1px solid #555;border-radius:18px;padding:5px 14px;font-family:'Bubblegum Sans',cursive;color:#888;cursor:pointer;font-size:.78rem;transition:all .2s;width:100%;}
.clr-btn:hover{border-color:#ff6b6b;color:#ff6b6b;}

/* SPELLBOOK */
.rscroll{max-height:480px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;}
.rscroll::-webkit-scrollbar{width:5px;}
.rscroll::-webkit-scrollbar-thumb{background:var(--purple);border-radius:4px;}
.rc{background:rgba(0,0,0,.3);border-radius:11px;padding:7px 9px;font-size:.76rem;transition:all .2s;}
.rc.unk{border:1px solid rgba(180,79,255,.2);}
.rc.unk:hover{border-color:var(--bright);background:rgba(180,79,255,.08);}
.rc.disc{border:1px dashed;}
.rc.disc.common{border-color:var(--c-common);}
.rc.disc.rare{border-color:var(--c-rare);}
.rc.disc.epic{border-color:var(--c-epic);}
.rc.disc.legendary{border-color:var(--c-legendary);box-shadow:0 0 8px rgba(255,153,0,.3);}
.rtag{font-size:.6rem;font-weight:bold;padding:1px 6px;border-radius:6px;float:right;text-transform:uppercase;}
.rtag.common{background:rgba(170,170,170,.25);color:var(--c-common);}
.rtag.rare{background:rgba(68,136,255,.25);color:var(--c-rare);}
.rtag.epic{background:rgba(204,68,255,.25);color:var(--c-epic);}
.rtag.legendary{background:rgba(255,153,0,.25);color:var(--c-legendary);}
.rname{color:var(--yellow);font-size:.86rem;}
.rings{font-size:.95rem;margin-top:2px;letter-spacing:1px;}
.rhint{color:#777;font-size:.68rem;margin-top:2px;}
.rfx{color:#bba0dd;font-size:.72rem;margin-top:4px;font-style:italic;line-height:1.35;}
.bfilter{display:flex;gap:5px;margin-bottom:8px;flex-wrap:wrap;}
.fbtn{background:transparent;border:1px solid #444;border-radius:10px;padding:3px 9px;font-family:'Bubblegum Sans',cursive;color:#888;cursor:pointer;font-size:.7rem;transition:all .2s;}
.fbtn.on{border-color:var(--bright);color:var(--bright);background:rgba(180,79,255,.15);}

/* MODALS */
.ovl{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:opacity .3s;}
.ovl.show{opacity:1;pointer-events:all;}
.card{background:linear-gradient(135deg,#1a0d2e,#2a1050);border:3px solid var(--bright);border-radius:24px;padding:26px;max-width:400px;width:92%;text-align:center;box-shadow:0 0 50px rgba(180,79,255,.5);transform:scale(.85);transition:transform .3s;max-height:92vh;overflow-y:auto;}
.ovl.show .card{transform:scale(1);}
#gameover-ovl .card{border-color:var(--yellow);}
.res-em{font-size:3.5rem;display:block;margin-bottom:8px;animation:wobble 1s infinite alternate;}
@keyframes wobble{0%{transform:rotate(-5deg) scale(1)}100%{transform:rotate(5deg) scale(1.1)}}
.res-title{font-family:'Creepster',cursive;font-size:1.7rem;color:var(--bright);}
.res-rar{font-size:.75rem;font-weight:bold;text-transform:uppercase;letter-spacing:1px;margin:4px 0;}
.cstrip{height:7px;border-radius:4px;margin:8px 0;}
.res-fx{background:rgba(0,0,0,.4);border-radius:13px;padding:10px;margin:10px 0;font-size:.92rem;line-height:1.5;border-left:3px solid var(--yellow);text-align:left;}
.res-sci{background:rgba(0,200,255,.08);border:1px solid rgba(0,200,255,.3);border-radius:11px;padding:9px;font-size:.78rem;color:#80e8ff;margin-bottom:10px;text-align:left;}
.new-badge{display:none;background:linear-gradient(135deg,#ffd700,#ff8800);color:#1a0a2e;font-family:'Creepster',cursive;font-size:.95rem;border-radius:18px;padding:4px 14px;margin-bottom:8px;animation:pulse .6s ease infinite alternate;}
@keyframes pulse{0%{transform:scale(1)}100%{transform:scale(1.05)}}
.pts-box{background:rgba(255,215,0,.07);border:1px solid rgba(255,215,0,.25);border-radius:11px;padding:9px 13px;margin:8px 0;font-size:.78rem;text-align:left;}
.pr{display:flex;justify-content:space-between;padding:2px 0;color:#ccc;}
.ptot{border-top:1px solid rgba(255,215,0,.3);margin-top:5px;padding-top:5px;color:var(--yellow);font-size:.95rem;font-family:'Creepster',cursive;}
.mbtn{background:linear-gradient(135deg,#6a0dad,#b44fff);border:none;border-radius:18px;padding:9px 26px;font-family:'Creepster',cursive;font-size:1.1rem;color:#fff;cursor:pointer;transition:transform .2s;margin-top:4px;}
.mbtn:hover{transform:scale(1.05);}

/* GAME OVER */
.go-title{font-family:'Creepster',cursive;font-size:2.2rem;color:var(--yellow);}
.go-score{font-family:'Creepster',cursive;font-size:3rem;color:var(--bright);}
.go-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:14px 0;}
.go-stat{background:rgba(0,0,0,.3);border:1px solid rgba(180,79,255,.3);border-radius:12px;padding:8px;}
.go-lbl{font-size:.62rem;color:#888;text-transform:uppercase;letter-spacing:.5px;}
.go-val{font-family:'Creepster',cursive;font-size:1.3rem;color:var(--yellow);}
.name-in{background:rgba(0,0,0,.4);border:2px solid var(--purple);border-radius:12px;padding:9px 14px;font-family:'Bubblegum Sans',cursive;font-size:1rem;color:#fff;width:100%;outline:none;margin-top:8px;}
.name-in:focus{border-color:var(--bright);}
.save-btn{background:linear-gradient(135deg,var(--yellow),var(--orange));color:#1a0a2e;border:none;border-radius:18px;padding:10px 28px;font-family:'Creepster',cursive;font-size:1.15rem;cursor:pointer;width:100%;margin-top:8px;}
.save-btn:hover{opacity:.9;}
.again-btn{background:linear-gradient(135deg,#6a0dad,#b44fff);color:#fff;border:none;border-radius:18px;padding:9px 26px;font-family:'Creepster',cursive;font-size:1.1rem;cursor:pointer;width:100%;margin-top:8px;}
.again-btn:hover{opacity:.9;}

/* LEADERBOARD */
.lb-wrap{margin-top:20px;}
.lb-title{font-family:'Creepster',cursive;font-size:1.6rem;color:var(--yellow);text-align:center;margin-bottom:12px;}
.lb-tabs{display:flex;gap:8px;margin-bottom:10px;}
.lb-tab{background:transparent;border:1px solid #444;border-radius:10px;padding:4px 12px;font-family:'Bubblegum Sans',cursive;color:#888;cursor:pointer;font-size:.75rem;transition:all .2s;}
.lb-tab.on{border-color:var(--yellow);color:var(--yellow);background:rgba(255,215,0,.08);}
table{width:100%;border-collapse:collapse;}
th{font-size:.7rem;color:#888;text-transform:uppercase;letter-spacing:.5px;padding:5px 8px;text-align:left;border-bottom:1px solid rgba(180,79,255,.2);}
td{padding:7px 8px;font-size:.88rem;border-bottom:1px solid rgba(255,255,255,.05);}
.lb-rank{font-family:'Creepster',cursive;font-size:1.1rem;color:var(--yellow);}
.lb-name{color:var(--text);}
.lb-score{font-family:'Creepster',cursive;font-size:1rem;color:var(--bright);}
.lb-sub{color:#888;font-size:.8rem;}
tr:nth-child(1) td{background:rgba(255,215,0,.06);}
tr:nth-child(2) td{background:rgba(200,200,200,.04);}
tr:nth-child(3) td{background:rgba(205,127,50,.04);}
tr.me td{background:rgba(180,79,255,.1);border-left:2px solid var(--bright);}
.lb-empty{text-align:center;color:#555;padding:20px;}

/* VISUAL EFFECTS (all fixed, all pointer-events:none) */
.cf-piece{position:fixed;top:-20px;font-size:1.4rem;animation:cf-fall linear forwards;pointer-events:none;z-index:150;}
@keyframes cf-fall{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(110vh) rotate(720deg);opacity:0}}
.ptcl{position:fixed;pointer-events:none;border-radius:50%;animation:ptcl-out ease-out forwards;z-index:50;}
@keyframes ptcl-out{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0}}
.fpts{position:fixed;font-family:'Creepster',cursive;font-size:1.3rem;color:#ffd700;text-shadow:0 0 8px gold;pointer-events:none;z-index:210;animation:fpts-up 1.4s ease-out forwards;}
@keyframes fpts-up{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-80px) scale(1.3)}}
.ing-fly{position:fixed;pointer-events:none;z-index:100;font-size:1.8rem;transition:left .45s cubic-bezier(.4,0,.6,1),top .45s cubic-bezier(.4,0,.6,1),transform .45s,opacity .45s;}
.fx-mist{position:fixed;border-radius:50%;pointer-events:none;z-index:40;animation:mist-up ease-out forwards;}
@keyframes mist-up{0%{opacity:.6;transform:translate(-50%,-50%) scale(.5)}100%{opacity:0;transform:translate(calc(-50% + var(--mx)),calc(-50% - 60px)) scale(1.8)}}
.fx-ring{position:fixed;border-radius:50%;pointer-events:none;z-index:40;animation:ring-out ease-out forwards;}
@keyframes ring-out{0%{transform:translate(-50%,-50%) scale(.1);opacity:1}100%{transform:translate(-50%,-50%) scale(2.5);opacity:0}}
.fx-rune{position:fixed;pointer-events:none;z-index:40;font-size:1.2rem;animation:rune-spin linear forwards;}
@keyframes rune-spin{0%{opacity:0;transform:translate(-50%,-50%) rotate(0deg) translateX(var(--rd)) rotate(0deg) scale(0)}20%{opacity:1}80%{opacity:1}100%{opacity:0;transform:translate(-50%,-50%) rotate(360deg) translateX(var(--rd)) rotate(-360deg) scale(0)}}
.fx-bottle{position:fixed;pointer-events:none;z-index:40;font-size:2.5rem;animation:bottle-up ease-out forwards;}
@keyframes bottle-up{0%{opacity:0;transform:translate(-50%,-50%) scale(.3) translateY(20px)}30%{opacity:1}70%{opacity:1;transform:translate(-50%,-50%) scale(1.2) translateY(-70px)}100%{opacity:0;transform:translate(-50%,-50%) scale(.8) translateY(-100px)}}
.fx-smoke{position:fixed;border-radius:50%;pointer-events:none;z-index:40;animation:smoke-up ease-out forwards;}
@keyframes smoke-up{0%{transform:translate(-50%,-50%) scale(.2);opacity:.7}100%{transform:translate(-50%,-50%) scale(2.5) translateY(-40px);opacity:0}}

/* SVG lightning canvas */
#lightning-canvas{position:fixed;pointer-events:none;z-index:41;}

@media(max-width:700px){
  .main{grid-template-columns:1fr;}
  .cauldron-area{order:-1;}
  .panel:last-child{order:2;}
  .igrid{grid-template-columns:repeat(3,1fr);gap:5px;}
  .ibtn{padding:7px 3px;}
  .ibtn .em{font-size:1.5rem;}
  .ibtn .nm{font-size:.62rem;}
  .ibtn .tg{font-size:.52rem;}
  .hud{gap:6px;}
  .hb{padding:4px 8px;min-width:55px;}
  .hv{font-size:1.1rem;}
  .hl{font-size:.5rem;}
  .brew-btn{padding:11px 18px;font-size:1.15rem;}
  .cw{width:200px;height:200px;}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WITCH BREW SEQUENCE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Overlay that dims the cauldron area during brew */
#brew-stage{
  position:fixed;inset:0;pointer-events:none;z-index:80;
  display:flex;align-items:center;justify-content:center;
}

/* Witch SVG wrapper â€” flies in from right */
#witch-wrap{
  position:fixed;pointer-events:none;z-index:90;
  transform-origin:bottom center;
  /* default hidden */
  opacity:0;
  transition:none;
}
#witch-wrap.fly-in{
  animation:witch-arrive .55s cubic-bezier(.2,1,.4,1) forwards;
}
#witch-wrap.brew-stir{
  animation:witch-stir .0s forwards; /* position hold â€” stir handled by arm */
}
#witch-wrap.fly-out{
  animation:witch-leave .5s cubic-bezier(.6,0,.8,1) forwards;
}
@keyframes witch-arrive{
  0%  {opacity:1;transform:translateX(-180px) translateY(30px) rotate(-8deg);}
  100%{opacity:1;transform:translateX(0px)    translateY(0px)  rotate(0deg);}
}
@keyframes witch-leave{
  0%  {opacity:1;transform:translateX(0)     translateY(0)    rotate(0deg);}
  100%{opacity:1;transform:translateX(-200px) translateY(-20px) rotate(-12deg);}
}

/* Witch stirring arm oscillation */
#witch-arm{
  transform-origin:45px 8px; /* left shoulder pivot */
  animation:none;
}
#witch-arm.stirring{
  animation:arm-stir .55s ease-in-out infinite alternate;
}
@keyframes arm-stir{
  0%  {transform:rotate(-30deg);}
  100%{transform:rotate(30deg);}
}

/* Witch hat bob */
#witch-hat{
  transform-origin:center bottom;
}
#witch-hat.bobbing{
  animation:hat-bob .55s ease-in-out infinite alternate;
}
@keyframes hat-bob{
  0%  {transform:rotate(-4deg) translateY(0px);}
  100%{transform:rotate(4deg)  translateY(-3px);}
}

/* Big smoke cloud that covers cauldron */
.brew-smoke{
  position:fixed;pointer-events:none;z-index:85;
  border-radius:50%;
  animation:brew-smoke-grow ease-out forwards;
}
@keyframes brew-smoke-grow{
  0%  {transform:translate(-50%,-50%) scale(0);   opacity:0;}
  30% {opacity:.92;}
  70% {opacity:.85;}
  100%{transform:translate(-50%,-50%) scale(1);   opacity:0;}
}

/* Cauldron rarity glow pulse (the big reveal) */
#cw-glow-reveal{
  position:fixed;pointer-events:none;z-index:82;
  border-radius:50%;
  opacity:0;
  transition:none;
}
#cw-glow-reveal.pulse{
  animation:reveal-pulse 1.1s ease-out forwards;
}
@keyframes reveal-pulse{
  0%  {opacity:0;  transform:translate(-50%,-50%) scale(.2);}
  25% {opacity:1;  transform:translate(-50%,-50%) scale(1);}
  70% {opacity:.7; transform:translate(-50%,-50%) scale(1.15);}
  100%{opacity:0;  transform:translate(-50%,-50%) scale(1.4);}
}

/* Witch speech bubble */
#witch-bubble{
  position:fixed;pointer-events:none;z-index:95;
  background:rgba(20,5,40,.92);
  border:2px solid var(--bright);
  border-radius:14px;
  padding:7px 14px;
  font-family:'Bubblegum Sans',cursive;
  font-size:.95rem;
  color:var(--text);
  white-space:nowrap;
  opacity:0;
  transform:scale(.8);
  transition:opacity .25s,transform .25s;
}
#witch-bubble::after{
  content:'';position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);
  border:5px solid transparent;border-top-color:var(--bright);
}
#witch-bubble.show{opacity:1;transform:scale(1);}


/* NEW GAME CONFIRM MODAL */
.confirm-card{max-width:340px;text-align:center;}
.confirm-title{font-family:'Creepster',cursive;font-size:1.6rem;color:var(--yellow);margin-bottom:8px;}
.confirm-msg{font-size:.92rem;color:#ccc;margin-bottom:20px;line-height:1.5;}
.confirm-btns{display:flex;gap:10px;justify-content:center;}
.confirm-yes{background:linear-gradient(135deg,#cc2200,#ff4422);color:#fff;border:none;border-radius:16px;padding:10px 26px;font-family:'Creepster',cursive;font-size:1.1rem;cursor:pointer;}
.confirm-yes:hover{opacity:.85;}
.confirm-no{background:transparent;border:2px solid #666;color:#aaa;border-radius:16px;padding:10px 26px;font-family:'Bubblegum Sans',cursive;font-size:.95rem;cursor:pointer;}
.confirm-no:hover{border-color:#aaa;color:#fff;}
.new-game-btn{background:transparent;border:1px solid rgba(180,79,255,.5);border-radius:12px;padding:5px 10px;font-family:'Bubblegum Sans',cursive;color:#b44fff;cursor:pointer;font-size:.78rem;transition:all .2s;margin-top:6px;white-space:nowrap;}
.new-game-btn:hover{background:rgba(180,79,255,.15);border-color:var(--bright);}
.hud-btn{margin-top:0;align-self:center;}
/* â”€â”€ FEEDBACK STRIP â”€â”€ */
.feedback-strip{margin-top:16px;padding:12px 16px;background:rgba(180,79,255,.06);border:1px solid rgba(180,79,255,.2);border-radius:14px;text-align:center;}
.feedback-text{font-size:.78rem;color:rgba(255,255,255,.5);margin-bottom:10px;}
.feedback-btns{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
.feedback-btn{font-size:.7rem;padding:7px 14px;border-radius:20px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:rgba(255,255,255,.65);text-decoration:none;transition:all .2s;white-space:nowrap;font-family:'Bubblegum Sans',cursive;}
.feedback-btn:hover{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.4);color:#fff;}
.feedback-claim{display:none;margin-top:10px;}
.feedback-claim-btn{font-family:'Bubblegum Sans',cursive;font-size:.72rem;padding:8px 18px;border-radius:20px;border:none;background:linear-gradient(135deg,#ffd700,#ff8800);color:#1a0a2e;font-weight:bold;cursor:pointer;transition:all .2s;animation:claimPop .4s cubic-bezier(.34,1.56,.64,1);}
@keyframes claimPop{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
.feedback-claim-btn:hover{transform:scale(1.06);box-shadow:0 4px 16px rgba(255,215,0,.4);}
.feedback-claim-btn:disabled{opacity:.5;cursor:default;transform:none;background:#555;}
</style>
<style>
.badge-toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:linear-gradient(135deg,#0d0a1a,#1a0d2e);border:2px solid #ffd700;border-radius:20px;padding:14px 22px;display:flex;align-items:center;gap:14px;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,.5),0 0 24px rgba(255,215,0,.3);transition:transform .5s cubic-bezier(.34,1.56,.64,1),opacity .4s;opacity:0;pointer-events:none;max-width:340px;}
.badge-toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
.badge-toast-em{font-size:2.4rem;flex-shrink:0;filter:drop-shadow(0 0 8px rgba(255,215,0,.8));animation:badgePop .6s cubic-bezier(.34,1.56,.64,1);}
@keyframes badgePop{0%{transform:scale(0) rotate(-20deg)}60%{transform:scale(1.3) rotate(5deg)}100%{transform:scale(1) rotate(0)}}
.badge-toast-text{display:flex;flex-direction:column;gap:2px;}
.badge-toast-label{font-size:.62rem;text-transform:uppercase;letter-spacing:2px;color:#ffd700;font-weight:bold;}
.badge-toast-name{font-size:1.05rem;color:#fff;font-weight:bold;}
.badge-toast-desc{font-size:.72rem;color:#e0b0ff;}
.badges-earned-row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:14px 0 4px;}
.badge-coin{display:flex;flex-direction:column;align-items:center;gap:4px;position:relative;}
.badge-coin-em{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8rem;border:3px solid #ffd700;background:radial-gradient(circle at 35% 30%,#fff9e6,#ffd700 60%,#b8860b);box-shadow:0 0 16px rgba(255,215,0,.5),inset 0 2px 4px rgba(255,255,255,.4);animation:coinShimmer 2s ease-in-out infinite alternate;}
@keyframes coinShimmer{from{box-shadow:0 0 10px rgba(255,215,0,.4)}to{box-shadow:0 0 24px rgba(255,215,0,.8),0 0 40px rgba(255,215,0,.3)}}
.badge-coin-name{font-size:.6rem;color:#ffd700;text-align:center;max-width:60px;line-height:1.2;}
.badge-coin.new-badge .badge-coin-em::after{content:'NEW!';position:absolute;top:-6px;right:-6px;background:#ff4444;color:#fff;font-size:.45rem;font-weight:bold;padding:2px 5px;border-radius:6px;letter-spacing:.5px;}
.badges-section-title{font-size:.75rem;text-transform:uppercase;letter-spacing:2px;color:#e0b0ff;text-align:center;margin-bottom:8px;}
.go-badges-wrap{margin:10px 0;padding:12px;background:rgba(180,79,255,.07);border:1px solid rgba(180,79,255,.25);border-radius:14px;}
</style>
</head>
<body>
<div class="moon">ğŸŒ•</div>
<div class="bat">ğŸ¦‡</div><div class="bat">ğŸ¦‡</div><div class="bat">ğŸ¦‡</div>
<canvas id="lightning-canvas" width="200" height="200"></canvas>


<!-- Brew stage overlay -->
<div id="brew-stage"></div>
<!-- Witch speech bubble -->
<div id="witch-bubble"></div>
<!-- Cauldron glow reveal overlay -->
<div id="cw-glow-reveal"></div>

<!-- The witch herself â€” detailed SVG, fixed positioned by JS -->
<div id="witch-wrap">
<svg id="witch-svg" width="130" height="180" viewBox="0 0 130 180" xmlns="http://www.w3.org/2000/svg">
  <!-- Broom -->
  <g id="witch-broom">
    <line x1="120" y1="155" x2="20" y2="140" stroke="#8B5E3C" stroke-width="4" stroke-linecap="round"/>
    <path d="M 30 138 Q 15 130 12 128 Q 15 135 12 142 Q 18 138 30 142 Z" fill="#C8A060"/>
    <path d="M 30 140 Q 22 132 14 128" stroke="#A07840" stroke-width="1.5" fill="none"/>
    <path d="M 28 143 Q 20 138 12 136" stroke="#A07840" stroke-width="1.5" fill="none"/>
  </g>
  <!-- Robe / body -->
  <path d="M 88 95 Q 100 120 105 165 Q 80 170 65 168 Q 50 170 25 165 Q 30 120 42 95 Z" fill="#2a0a4a"/>
  <path d="M 88 95 Q 100 120 105 165 Q 80 170 65 168 Q 50 170 25 165 Q 30 120 42 95 Z" fill="none" stroke="#6a0dad" stroke-width="1.5"/>
  <!-- Robe stars -->
  <text x="82" y="130" font-size="9" fill="#ffd700" opacity=".7">âœ¦</text>
  <text x="47" y="150" font-size="7" fill="#b44fff" opacity=".8">âœ¦</text>
  <text x="65" y="155" font-size="6" fill="#ffd700" opacity=".6">âœ¦</text>
  <!-- Belt -->
  <rect x="40" y="112" width="50" height="7" rx="3" fill="#4a1a7a"/>
  <rect x="60" y="110" width="10" height="11" rx="2" fill="#ffd700" opacity=".8"/>
  <!-- Neck -->
  <rect x="58" y="80" width="14" height="16" rx="5" fill="#f4c090"/>
  <!-- Head -->
  <ellipse cx="65" cy="72" rx="22" ry="20" fill="#f4c090"/>
  <!-- Hair -->
  <path d="M 87 70 Q 92 80 94 90" stroke="#1a0a00" stroke-width="4" fill="none" stroke-linecap="round"/>
  <path d="M 83 68 Q 88 79 89 88" stroke="#2a1000" stroke-width="3" fill="none" stroke-linecap="round"/>
  <path d="M 43 70 Q 38 80 36 90" stroke="#1a0a00" stroke-width="4" fill="none" stroke-linecap="round"/>
  <!-- Eyes -->
  <ellipse cx="56" cy="70" rx="5" ry="5.5" fill="white"/>
  <ellipse cx="74" cy="70" rx="5" ry="5.5" fill="white"/>
  <ellipse cx="57" cy="71" rx="3.5" ry="3.5" fill="#1a0040"/>
  <ellipse cx="75" cy="71" rx="3.5" ry="3.5" fill="#1a0040"/>
  <circle cx="58.5" cy="69.5" r="1" fill="white"/>
  <circle cx="76.5" cy="69.5" r="1" fill="white"/>
  <!-- Eyebrows -->
  <path d="M 51 64 Q 56 61 61 63" stroke="#2a1000" stroke-width="2" fill="none" stroke-linecap="round"/>
  <path d="M 69 63 Q 74 61 79 64" stroke="#2a1000" stroke-width="2" fill="none" stroke-linecap="round"/>
  <!-- Nose -->
  <path d="M 63 74 Q 61 79 65 80 Q 69 79 67 74" fill="#e8a870" stroke="none"/>
  <!-- Smile -->
  <path d="M 57 83 Q 65 87 73 83" stroke="#c07050" stroke-width="2" fill="none" stroke-linecap="round"/>
  <!-- Wart -->
  <circle cx="57" cy="78" r="2" fill="#d4a06a"/>
  <!-- Cheek blush -->
  <ellipse cx="50" cy="78" rx="5" ry="3" fill="#ff8888" opacity=".3"/>
  <ellipse cx="80" cy="78" rx="5" ry="3" fill="#ff8888" opacity=".3"/>
  <!-- Hat brim -->
  <ellipse cx="65" cy="52" rx="30" ry="8" fill="#1a0030"/>
  <ellipse cx="65" cy="52" rx="30" ry="8" fill="none" stroke="#6a0dad" stroke-width="1.5"/>
  <!-- Hat cone -->
  <g id="witch-hat">
    <path d="M 65 0 L 38 52 L 92 52 Z" fill="#1a0030"/>
    <path d="M 65 0 L 38 52 L 92 52 Z" fill="none" stroke="#6a0dad" stroke-width="1.5"/>
    <rect x="40" y="43" width="50" height="8" rx="2" fill="#6a0dad"/>
    <rect x="59" y="42" width="12" height="10" rx="2" fill="#ffd700" opacity=".9"/>
    <rect x="61" y="44" width="8" height="6" rx="1" fill="#1a0030"/>
    <text x="74" y="35" font-size="8" fill="#ffd700" opacity=".8">â˜…</text>
    <text x="48" y="28" font-size="6" fill="#b44fff" opacity=".9">â˜…</text>
    <text x="60" y="20" font-size="5" fill="#ffd700" opacity=".7">âœ¦</text>
  </g>
  <!-- LEFT stirring arm â€” pivot at shoulder ~(45,95) -->
  <g id="witch-arm">
    <path d="M 45 98 Q 32 108 25 125" stroke="#2a0a4a" stroke-width="9" fill="none" stroke-linecap="round"/>
    <ellipse cx="25" cy="126" rx="7" ry="5" fill="#4a1a7a" transform="rotate(20,25,126)"/>
    <ellipse cx="22" cy="133" rx="7" ry="6" fill="#f4c090" transform="rotate(20,22,133)"/>
    <path d="M 26 130 Q 30 125 28 120" stroke="#e8a870" stroke-width="2.5" fill="none" stroke-linecap="round"/>
    <path d="M 17 130 Q 13 124 15 119" stroke="#e8a870" stroke-width="2.5" fill="none" stroke-linecap="round"/>
    <!-- Wand / spoon -->
    <line x1="18" y1="128" x2="2" y2="155" stroke="#8B5E3C" stroke-width="3" stroke-linecap="round"/>
    <circle cx="0" cy="157" r="5" fill="#ffd700" opacity=".9"/>
    <circle cx="0" cy="157" r="3" fill="white" opacity=".6"/>
  </g>
  <!-- Right arm (resting) -->
  <path d="M 85 98 Q 98 112 102 128" stroke="#2a0a4a" stroke-width="9" fill="none" stroke-linecap="round"/>
  <ellipse cx="103" cy="130" rx="7" ry="5" fill="#4a1a7a" transform="rotate(-20,103,130)"/>
  <ellipse cx="106" cy="137" rx="7" ry="6" fill="#f4c090" transform="rotate(-20,106,137)"/>
</svg>
</div>

<div class="wrap">
  <header>
    <h1>ğŸ§™â€â™€ï¸ Witch's Brew Workshop</h1>
    <div class="hud">
      <div class="hb"><span class="hl">â­ Score</span><span class="hv" id="h-score">0</span></div>
      <div class="hb streak-hb" id="h-streak-b"><span class="hl">ğŸ”¥ Streak</span><span class="hv" id="h-streak">Ã—1</span></div>
      <div class="hb tries-hb" id="h-tries-b"><span class="hl">ğŸ§ª Tries Left</span><span class="hv" id="h-tries">10</span></div>
      <button class="new-game-btn hud-btn" id="new-game-btn">ğŸ”„ New</button>
      <a href="index.html" class="new-game-btn hud-btn" style="text-decoration:none;">ğŸ¦€ Home</a>
      <div id="potion-avatar-hud" style="display:flex;align-items:center;gap:4px;padding:0 4px;" title="Your Crew"></div>
    </div>
    <div class="xpbar"><div class="xpfill" id="xpfill" style="width:0%"></div></div>
    <p class="hint">1st try = max speed bonus Â· consecutive finds = streak multiplier up to Ã—4</p>
  </header>

  <div class="main">
    <!-- Ingredients -->
    <div class="panel">
      <div class="ptitle">ğŸŒ¿ Ingredient Shelf</div>
      <div class="igrid" id="igrid"></div>
    </div>

    <!-- Cauldron (centre) -->
    <div class="cauldron-area">
      <!-- Fixed-size wrapper with pointer-events:none on all children -->
      <div class="cw" id="cw">
        <div id="bub-c" style="position:absolute;inset:0;overflow:hidden;pointer-events:none;"></div>
        <div class="steam">ğŸ’¨</div><div class="steam">ğŸ’¨</div><div class="steam">ğŸ’¨</div>
        <svg style="width:100%;height:100%;pointer-events:none;" viewBox="0 0 180 180" xmlns="http://www.w3.org/2000/svg">
          <rect x="55" y="150" width="12" height="25" rx="4" fill="#1a0a2e"/>
          <rect x="113" y="150" width="12" height="25" rx="4" fill="#1a0a2e"/>
          <path d="M 30 90 Q 15 70 30 55 Q 45 40 55 60" stroke="#3d2060" stroke-width="6" fill="none" stroke-linecap="round"/>
          <path d="M 150 90 Q 165 70 150 55 Q 135 40 125 60" stroke="#3d2060" stroke-width="6" fill="none" stroke-linecap="round"/>
          <ellipse cx="90" cy="145" rx="65" ry="15" fill="#0d0720" opacity="0.6"/>
          <path d="M 30 90 Q 25 145 90 155 Q 155 145 150 90 Z" fill="#1a0a2e"/>
          <path d="M 30 90 Q 25 145 90 155 Q 155 145 150 90 Z" fill="none" stroke="#3d2060" stroke-width="3"/>
          <ellipse cx="90" cy="90" rx="60" ry="18" fill="#2a1050"/>
          <ellipse cx="90" cy="90" rx="60" ry="18" fill="none" stroke="#6a0dad" stroke-width="3"/>
          <ellipse id="brew-liquid" cx="90" cy="90" rx="55" ry="14" fill="#1a4a1a" opacity="0.85"/>
          <ellipse cx="75" cy="85" rx="20" ry="5" fill="white" opacity="0.07"/>
        </svg>
        <div class="brew-glow" id="brew-glow" style="background:rgba(57,255,20,.3);"></div>
      </div>
      <!-- Flames overlap the bottom of the cauldron -->
      <div class="flame-row" style="margin-top:-52px;">
        <div class="flame"></div><div class="flame"></div><div class="flame"></div>
        <div class="flame"></div><div class="flame"></div>
      </div>
      <!-- Ingredient slots above brew button -->
      <div class="cauldron-slots" id="cauldron-slots">
        <div class="cslot empty-slot" id="cslot-0"><span class="cslot-em"></span></div>
        <div class="cslot empty-slot" id="cslot-1"><span class="cslot-em"></span></div>
        <div class="cslot empty-slot" id="cslot-2"><span class="cslot-em"></span></div>
      </div>
      <button class="brew-btn" id="brew-btn" disabled>ğŸ”® BREW IT!</button>
    </div>

    <!-- Spell Book -->
    <div class="panel">
      <div class="ptitle">ğŸ“– Spell Book <span id="sb-found" style="font-family:'Bubblegum Sans',cursive;font-size:.85rem;color:#888;font-weight:normal;vertical-align:middle;margin-left:4px;">0/55</span></div>
      <div class="bfilter" id="bfilter">
        <button class="fbtn on" data-f="all">All</button>
        <button class="fbtn" data-f="common" style="color:var(--c-common)">Common</button>
        <button class="fbtn" data-f="rare" style="color:var(--c-rare)">Rare</button>
        <button class="fbtn" data-f="epic" style="color:var(--c-epic)">Epic</button>
        <button class="fbtn" data-f="legendary" style="color:var(--c-legendary)">Legendary</button>
      </div>
      <div class="rscroll" id="rlist"></div>
    </div>
  </div>

  <!-- Leaderboard -->
  <div class="lb-wrap">
    <div class="panel">
      <div class="lb-title">ğŸ† Hall of Witches</div>
      <div class="lb-tabs">
        <button class="lb-tab on" id="lbt-score" onclick="lbTab('score')">Top Score</button>
        <button class="lb-tab" id="lbt-found" onclick="lbTab('found')">Most Found</button>
      </div>
      <div id="lb-body"></div>
    </div>
  </div>
</div>

<!-- Result modal -->
<div class="ovl" id="res-ovl">
  <div class="card">
    <div class="new-badge" id="new-badge">â­ NEW DISCOVERY! â­</div>
    <span class="res-em" id="res-em">âœ¨</span>
    <div class="res-title" id="res-name"></div>
    <div class="res-rar" id="res-rar"></div>
    <div class="cstrip" id="res-strip"></div>
    <div class="res-fx" id="res-fx"></div>
    <div class="res-sci" id="res-sci"></div>
    <div class="pts-box" id="res-pts" style="display:none"></div>
    <button class="mbtn" id="close-btn">ğŸŒŸ Keep Brewing!</button>
  </div>
</div>

<!-- Game over modal -->
<div class="ovl" id="gameover-ovl">
  <div class="card">
    <div class="go-title">ğŸ§™â€â™€ï¸ Time's Up!</div>
    <div style="font-size:.9rem;color:#aaa;margin:6px 0">10 tries used. Here's your result:</div>
    <div class="go-score" id="go-score">0</div>
    <div class="go-grid">
      <div class="go-stat"><div class="go-lbl">Potions Found</div><div class="go-val" id="go-found">0</div></div>
      <div class="go-stat"><div class="go-lbl">Best Streak</div><div class="go-val" id="go-streak">0</div></div>
      <div class="go-stat"><div class="go-lbl">Common</div><div class="go-val" id="go-common">0</div></div>
      <div class="go-stat"><div class="go-lbl">Rare</div><div class="go-val" id="go-rare">0</div></div>
      <div class="go-stat"><div class="go-lbl">Epic</div><div class="go-val" id="go-epic">0</div></div>
      <div class="go-stat"><div class="go-lbl">Legendary</div><div class="go-val" id="go-legendary">0</div></div>
    </div>
    <label style="font-size:.85rem;color:#aaa;">Enter your witch name:</label>
    <input class="name-in" type="text" id="player-name" maxlength="20" placeholder="SpookyWitch42">
    <button class="save-btn" id="save-btn">ğŸ† Save to Leaderboard!</button>
    <div class="go-badges-wrap" id="goBadgesWrap" style="display:none">
      <div class="badges-section-title">ğŸ† Badges Earned!</div>
      <div class="badges-earned-row" id="goBadgesRow"></div>
    </div>
    <button class="again-btn" id="again-btn">ğŸ”„ Play Again</button>
    <a href="index.html" class="again-btn" style="text-decoration:none;display:block;text-align:center;margin-top:8px;background:linear-gradient(135deg,#1a0d2e,#2a1050);border:2px solid rgba(180,79,255,.5);">ğŸ¦€ Home</a>
    <div class="feedback-strip">
      <p class="feedback-text">ğŸ’Œ Found a bug or have a game idea?</p>
      <div class="feedback-btns">
        <a class="feedback-btn" href="/cdn-cgi/l/email-protection#e088858c8c8fa08392818283818b85ce8b898493df9395828a858394dda29587c5d2d0b285908f9294c5d2d0c5a5d2c5d8d0c5d9d3c5d2d0b789948388c5d2d793c5d2d0a2928597c6828f8499dda889c1c5d2d0a9c5d2d0868f958e84c5d2d081c5d2d0829587c5d2d0898ec5d2d0b789948388c5d2d793c5d2d0a2928597c5d3a1c5d0a1c5d0a1" onclick="showClaim('bug')">ğŸ› Report a Bug</a>
        <a class="feedback-btn" href="/cdn-cgi/l/email-protection#59313c353536193a2b383b3a38323c7732303d2a662a2c3b333c3a2d641e38343c7c6b69103d3c387c6b693f362b7c6b691a2b383b3a38323c787f3b363d20641130787c6b69107c6b6931382f3c7c6b6938377c6b69303d3c387c6b693f362b7c6b69387c6b69373c2e7c6b693e38343c7c6a187c69187c6918" onclick="showClaim('idea')">ğŸ’¡ Suggest a Game</a>
      </div>
      <div class="feedback-claim" id="feedback-claim-bug">
        <button class="feedback-claim-btn" onclick="claimFeedbackBadge('bug')">âœ… I sent it! Claim my ğŸ› Bug Hunter badge</button>
      </div>
      <div class="feedback-claim" id="feedback-claim-idea">
        <button class="feedback-claim-btn" onclick="claimFeedbackBadge('idea')">âœ… I sent it! Claim my ğŸ’¡ Big Ideas badge</button>
      </div>
    </div>
  </div>
</div>

<!-- New game confirm modal -->
<div class="ovl" id="confirm-ovl">
  <div class="card confirm-card">
    <div class="confirm-title">&#x26A0;&#xFE0F; Start New Game?</div>
    <div class="confirm-msg">This will reset your current game â€” score, tries and discoveries will be lost.<br><br>Are you sure?</div>
    <div class="confirm-btns">
      <button class="confirm-yes" id="confirm-yes-btn">Yes, reset!</button>
      <button class="confirm-no" id="confirm-no-btn">Cancel</button>
    </div>
  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RARITY={
  common:  {label:'Common',   color:'#aaaaaa',base:100, spd:100, em:'âšª'},
  rare:    {label:'Rare',     color:'#4488ff',base:250, spd:200, em:'ğŸ”µ'},
  epic:    {label:'Epic',     color:'#cc44ff',base:500, spd:400, em:'ğŸŸ£'},
  legendary:{label:'Legendary',color:'#ff9900',base:1000,spd:800,em:'ğŸŸ '},
};

const ING=[
  {id:'moonflower', em:'ğŸŒ¸',name:'Moonflower',  tag:'magic',  tc:'tag-magic',  col:'#ff80ff'},
  {id:'bat_wing',   em:'ğŸ¦‡',name:'Bat Wing',    tag:'spooky', tc:'tag-spooky', col:'#7a40a0'},
  {id:'spider_web', em:'ğŸ•¸ï¸',name:'Spider Web',  tag:'spooky', tc:'tag-spooky', col:'#888888'},
  {id:'frog_tongue',em:'ğŸ¸',name:'Frog Tongue', tag:'nature', tc:'tag-nature', col:'#39ff14'},
  {id:'dragon_scale',em:'ğŸ‰',name:'Dragon Scale',tag:'magic', tc:'tag-magic',  col:'#ff4400'},
  {id:'star_dust',  em:'âœ¨',name:'Star Dust',   tag:'magic',  tc:'tag-magic',  col:'#ffd700'},
  {id:'mushroom',   em:'ğŸ„',name:'Gloom Shroom',tag:'nature', tc:'tag-nature', col:'#cc44aa'},
  {id:'eye_newt',   em:'ğŸ‘ï¸',name:'Eye of Newt', tag:'spooky', tc:'tag-spooky', col:'#ff8800'},
  {id:'lightning',  em:'âš¡',name:'Lightning',   tag:'science',tc:'tag-science',col:'#ffff00'},
  {id:'slime',      em:'ğŸŸ¢',name:'Swamp Slime', tag:'science',tc:'tag-science',col:'#00cc44'},
  {id:'crystal',    em:'ğŸ’',name:'Witch Crystal',tag:'magic', tc:'tag-magic',  col:'#00ffff'},
  {id:'bones',      em:'ğŸ¦´',name:'Creaky Bones',tag:'spooky', tc:'tag-spooky', col:'#f0e0b0'},
];
const M='moonflower',BW='bat_wing',SW='spider_web',FT='frog_tongue',
      DS='dragon_scale',SD='star_dust',MU='mushroom',EN='eye_newt',
      LI='lightning',SL='slime',CR='crystal',BO='bones';

const RCP=[
  // COMMON (25)
  {id:'flying',      r:'common',   n:'ğŸ¦‹ Flying Potion',      i:[M,BW,SD],  col:'#cc66ff',em:'ğŸª„',  fx:'ğŸ’œ Your arms sprout wings and you soar above the clouds!',sci:'ğŸ”¬ Wings create lift the same way airplane wings do!'},
  {id:'jump',        r:'common',   n:'ğŸ¸ Super Jump Juice',   i:[FT,LI,SL], col:'#44ff44',em:'âš¡ğŸ¸',fx:'ğŸ’š BOING! You bounce so high you can see your house from the sky!',sci:'ğŸ”¬ Frogs jump 20x their body length using tendons like springs!'},
  {id:'invisible',   r:'common',   n:'ğŸ‘» Invisibility Brew',  i:[EN,SW,CR], col:'#aaffff',em:'ğŸ‘»',  fx:'ğŸŒ€ POP! You vanish! Your sibling keeps walking into you.',sci:'ğŸ”¬ Some animals use camouflage to disappear into surroundings!'},
  {id:'fire_breath', r:'common',   n:'ğŸ”¥ Dragon Breath',      i:[DS,LI,MU], col:'#ff4400',em:'ğŸ‰ğŸ”¥',fx:'ğŸ”¥ WHOOSH! You breathe real fire! Great for toasting marshmallows!',sci:'ğŸ”¬ Bombardier beetles shoot boiling liquid â€” nature\'s fire breath!'},
  {id:'sizechange',  r:'common',   n:'ğŸ„ Wobbly Size Potion', i:[MU,SL,FT], col:'#ff44cc',em:'ğŸ„âœ¨',fx:'ğŸŒ€ You grow huge then shrink tiny then huge again for 10 minutes!',sci:'ğŸ”¬ Some materials stretch over 1000% their size â€” like super-elastic polymers!'},
  {id:'skeleton',    r:'common',   n:'ğŸ’€ Spooky Dancer',      i:[BO,BW,SW], col:'#8844aa',em:'ğŸ’€ğŸ•º',fx:'ğŸ’€ Your skeleton pops out and does a funky dance, then climbs back in!',sci:'ğŸ”¬ Humans have 206 bones. Babies start with ~270 â€” some fuse as you grow!'},
  {id:'wish',        r:'common',   n:'â­ Wish Potion',        i:[SD,M,CR],  col:'#ffd700',em:'â­ğŸŒŸ',fx:'âœ¨ A tiny genie appears and grants one silly wish. (You wished for a pet cloud.)',sci:'ğŸ”¬ Stars make light through nuclear fusion â€” turning hydrogen into helium!'},
  {id:'bubble',      r:'common',   n:'ğŸ«§ Bubble Bath Brew',   i:[SL,SW,M],  col:'#88ccff',em:'ğŸ«§',  fx:'ğŸ«§ You turn into a giant soap bubble and float for 5 minutes!',sci:'ğŸ”¬ Bubbles are spheres because that shape uses the least surface area!'},
  {id:'rainbow',     r:'common',   n:'ğŸŒˆ Rainbow Sneeze',     i:[M,SD,SL],  col:'#ff99cc',em:'ğŸŒˆ',  fx:'ğŸŒˆ Every time you sneeze you shoot rainbows out of your nose!',sci:'ğŸ”¬ Rainbows form when sunlight bends through water droplets!'},
  {id:'speed',       r:'common',   n:'ğŸ’¨ Speed Dash Brew',    i:[LI,FT,BW], col:'#88ffff',em:'ğŸ’¨âš¡',fx:'ğŸ’¨ You zip around so fast everything looks like a blur!',sci:'ğŸ”¬ The fastest humans run ~45 km/h. Cheetahs reach 120 km/h!'},
  {id:'glow',        r:'common',   n:'ğŸ’¡ Glowworm Gulp',      i:[CR,LI,M],  col:'#ccffaa',em:'ğŸ’¡',  fx:'ğŸ’¡ You glow bright green in the dark. Night-lights are obsolete!',sci:'ğŸ”¬ Fireflies glow using a chemical reaction called bioluminescence!'},
  {id:'echo',        r:'common',   n:'ğŸ“¢ Echo Elixir',        i:[BO,CR,SW], col:'#aaaacc',em:'ğŸ“¢',  fx:'ğŸ“¢ Everything you say echoes 5 times. Conversations take forever.',sci:'ğŸ”¬ Echoes happen when sound waves bounce off hard surfaces!'},
  {id:'magnet',      r:'common',   n:'ğŸ§² Magnet Milk',        i:[LI,BO,CR], col:'#ff8866',em:'ğŸ§²',  fx:'ğŸ§² You attract all metal within 10 metres. Very inconvenient.',sci:'ğŸ”¬ Magnets attract iron because their electrons all spin the same way!'},
  {id:'sticky',      r:'common',   n:'ğŸ¯ Sticky Finger Syrup',i:[SL,SW,FT], col:'#ffcc44',em:'ğŸ¯',  fx:'ğŸ¯ Your hands are super sticky. You can walk on walls but can\'t put down your sandwich.',sci:'ğŸ”¬ Geckos stick to walls using van der Waals forces from tiny hairs!'},
  {id:'shrink',      r:'common',   n:'ğŸ”¬ Shrink Drop',        i:[MU,CR,EN], col:'#44ccaa',em:'ğŸ”¬',  fx:'ğŸ”¬ You shrink to the size of a grape! Everything looks enormous!',sci:'ğŸ”¬ At tiny scales, surface tension becomes so strong insects can walk on water!'},
  {id:'bouncy',      r:'common',   n:'ğŸ€ Bouncy Brew',        i:[BO,BW,SL], col:'#ff9933',em:'ğŸ€',  fx:'ğŸ€ Your body becomes rubber and you bounce off every surface!',sci:'ğŸ”¬ Rubber bounces because it stores kinetic energy in its elastic bonds!'},
  {id:'frog',        r:'common',   n:'ğŸ¸ Frog Transform',     i:[BW,FT,MU], col:'#44aa44',em:'ğŸ¸',  fx:'ğŸ¸ You turn into a small green frog! Everything looks tastier.',sci:'ğŸ”¬ Frogs breathe through their skin as well as their lungs!'},
  {id:'hairy',       r:'common',   n:'ğŸ¦ Hairy Hulk Brew',    i:[BO,MU,BW], col:'#cc8844',em:'ğŸ¦',  fx:'ğŸ¦ You grow fur all over! Warm in winter, but brushing takes forever.',sci:'ğŸ”¬ Hair is made of keratin â€” the same protein as rhino horns!'},
  {id:'loud',        r:'common',   n:'ğŸ“£ Loud Mouth Lager',   i:[LI,EN,BO], col:'#ff6644',em:'ğŸ“£',  fx:'ğŸ“£ Your voice is 1000x louder. Whispering shatters windows.',sci:'ğŸ”¬ Whispering is ~30dB; a jet engine is 140dB!'},
  {id:'cold',        r:'common',   n:'â„ï¸ Iceberg Icicle',      i:[CR,SW,M],  col:'#aaddff',em:'â„ï¸',  fx:'â„ï¸ You breathe out blizzards! Great in summer, less great at cinema.',sci:'ğŸ”¬ Ice takes up more space than liquid water â€” which is why it floats!'},
  {id:'smelly',      r:'common',   n:'ğŸ’¨ Stinky Stench',      i:[BO,FT,SD], col:'#aacc44',em:'ğŸ’¨',  fx:'ğŸ’¨ You emit an unbelievable stench. Even skunks avoid you.',sci:'ğŸ”¬ Skunk spray is detectable by humans at incredibly small concentrations!'},
  {id:'night',       r:'common',   n:'ğŸŒ™ Night Vision Noggin',i:[EN,BW,CR], col:'#334466',em:'ğŸŒ™',  fx:'ğŸŒ™ You can see perfectly in total darkness! Torches now blind you.',sci:'ğŸ”¬ Cats have a reflective layer behind their eyes that amplifies light!'},
  {id:'copy',        r:'common',   n:'ğŸ‘¯ Copycat Concoction', i:[M,EN,MU],  col:'#ff88aa',em:'ğŸ‘¯',  fx:'ğŸ‘¯ An exact copy of you appears! It copies everything you do.',sci:'ğŸ”¬ Identical twins are natural clones â€” same DNA from one egg!'},
  {id:'forgetful',   r:'common',   n:'ğŸ§  Forgetful Flask',    i:[MU,BO,SW], col:'#cc9999',em:'ğŸ§ ',  fx:'ğŸ§  You forget every word except "banana". Conversations are limited.',sci:'ğŸ”¬ Memory is stored as patterns of connected neurons!'},
  {id:'hiccup',      r:'common',   n:'ğŸ« Hiccup Hex Brew',    i:[SL,BO,LI], col:'#ff99bb',em:'ğŸ«',  fx:'ğŸ« You get hiccups that shoot you 2 metres in the air each time!',sci:'ğŸ”¬ Hiccups are caused by spasms of the diaphragm!'},
  // RARE (15)
  {id:'time_slow',   r:'rare',     n:'â±ï¸ Time Slowing Tonic', i:[CR,LI,SD], col:'#4488ff',em:'â±ï¸',  fx:'â±ï¸ Time slows to a crawl! You dodge anything. Lunch takes 3 hours.',sci:'ğŸ”¬ Einstein\'s relativity shows time moves slower near massive objects!'},
  {id:'teleport',    r:'rare',     n:'ğŸŒ€ Teleport Tincture',  i:[SD,M,LI],  col:'#8844ff',em:'ğŸŒ€',  fx:'ğŸŒ€ You teleport to random locations every 30 seconds!',sci:'ğŸ”¬ Quantum teleportation is real â€” scientists have teleported particles!'},
  {id:'mind_read',   r:'rare',     n:'ğŸ§  Mind Reader Mix',    i:[EN,CR,SD], col:'#ff44aa',em:'ğŸ§ ',  fx:'ğŸ§  You can hear everyone\'s thoughts. Mostly sandwiches.',sci:'ğŸ”¬ EEG machines can literally read brain wave patterns!'},
  {id:'clone',       r:'rare',     n:'ğŸ‘¥ Clone Concoction',   i:[M,SD,MU],  col:'#44ffaa',em:'ğŸ‘¥',  fx:'ğŸ‘¥ You split into 3 clones! Great for chores, chaos for everything else.',sci:'ğŸ”¬ Identical twins are natural clones from one fertilised egg!'},
  {id:'plant',       r:'rare',     n:'ğŸŒ¿ Plant Person Potion',i:[FT,MU,M],  col:'#44cc44',em:'ğŸŒ¿',  fx:'ğŸŒ¿ You grow roots and photosynthesise! Sunlight and water only.',sci:'ğŸ”¬ Plants convert COâ‚‚ + water + sunlight into glucose using chlorophyll!'},
  {id:'metal',       r:'rare',     n:'ğŸ¤– Metal Skin Serum',   i:[BO,BW,CR], col:'#8899aa',em:'ğŸ¤–',  fx:'ğŸ¤– Your skin turns to steel! Bulletproof, but swimming is tricky.',sci:'ğŸ”¬ Spider silk is stronger than steel by weight!'},
  {id:'antigrav',    r:'rare',     n:'ğŸš€ Anti-Gravity Gulp',  i:[CR,SD,BW], col:'#aaccff',em:'ğŸš€',  fx:'ğŸš€ Gravity reverses for you! You float helplessly towards the ceiling.',sci:'ğŸ”¬ Astronauts in orbit are in constant free fall around Earth!'},
  {id:'weather',     r:'rare',     n:'ğŸŒ©ï¸ Weather Wizard Brew',i:[LI,CR,BW], col:'#6688cc',em:'ğŸŒ©ï¸',  fx:'ğŸŒ©ï¸ You control the weather! It rains on enemies, not you.',sci:'ğŸ”¬ Lightning is 5x hotter than the surface of the sun!'},
  {id:'undersea',    r:'rare',     n:'ğŸ™ Deep Sea Draught',   i:[SL,CR,FT], col:'#2255aa',em:'ğŸ™',  fx:'ğŸ™ You grow gills and tentacles! Breathing underwater is great.',sci:'ğŸ”¬ Deep ocean animals use bioluminescence â€” no sunlight reaches there!'},
  {id:'fire_immune', r:'rare',     n:'ğŸ”¥ Fireproof Flask',    i:[DS,CR,BO], col:'#ff6600',em:'ğŸ”¥',  fx:'ğŸ”¥ Fire cannot hurt you! Best barbecue companion ever.',sci:'ğŸ”¬ Salamanders were once thought to be born from fire!'},
  {id:'siren',       r:'rare',     n:'ğŸµ Siren Song Serum',   i:[M,BO,SD],  col:'#ff66cc',em:'ğŸµ',  fx:'ğŸµ Your voice is irresistible. Everyone does what you sing!',sci:'ğŸ”¬ The fork-tailed drongo mimics alarm calls to manipulate other species!'},
  {id:'electric',    r:'rare',     n:'âš¡ Electric Eel Elixir',i:[LI,SL,BO], col:'#ffffaa',em:'âš¡',  fx:'âš¡ You generate 600 volts! Handy for charging phones.',sci:'ğŸ”¬ Electric eels can generate 600 volts â€” enough to stun a horse!'},
  {id:'shadow',      r:'rare',     n:'ğŸŒ‘ Shadow Walker',      i:[BW,EN,BO], col:'#330033',em:'ğŸŒ‘',  fx:'ğŸŒ‘ You step into shadows and travel through darkness instantly!',sci:'ğŸ”¬ Shadows are the absence of light â€” photons travel in straight lines!'},
  {id:'telepathy',   r:'rare',     n:'ğŸ“¡ Telepathy Tea',      i:[EN,SD,M],  col:'#cc88ff',em:'ğŸ“¡',  fx:'ğŸ“¡ You send thoughts directly into people\'s heads. Very startling.',sci:'ğŸ”¬ BCI research aims to let humans communicate brain-to-brain!'},
  {id:'lava',        r:'rare',     n:'ğŸŒ‹ Lava Lad Lotion',    i:[DS,LI,SL], col:'#ff3300',em:'ğŸŒ‹',  fx:'ğŸŒ‹ Your footsteps melt the floor! Great for dramatic entrances.',sci:'ğŸ”¬ Lava reaches 1200Â°C. From Latin "labes" meaning a falling!'},
  // EPIC (10)
  {id:'immortal',    r:'epic',     n:'â™¾ï¸ Immortality Infusion',i:[M,MU,CR], col:'#cc44ff',em:'â™¾ï¸',  fx:'â™¾ï¸ You stop ageing! Great news â€” you still have homework forever.',sci:'ğŸ”¬ Lobsters don\'t age â€” they get stronger each year thanks to telomerase!'},
  {id:'omnilingual', r:'epic',     n:'ğŸ—£ï¸ All-Tongue Tincture',i:[FT,EN,M], col:'#ff88ff',em:'ğŸ—£ï¸',  fx:'ğŸ—£ï¸ You speak every language â€” including Dog, Cat, Whale, and Bee!',sci:'ğŸ”¬ Bees communicate through a "waggle dance" giving direction and distance!'},
  {id:'matter',      r:'epic',     n:'ğŸ§± Matter Moulding Mix',i:[CR,DS,BO], col:'#aaccff',em:'ğŸ§±',  fx:'ğŸ§± You reshape any solid object with your hands. LEGO is irrelevant.',sci:'ğŸ”¬ At the quantum level, matter is mostly empty space!'},
  {id:'dream',       r:'epic',     n:'ğŸ’¤ Dream Diver Draught',i:[M,MU,SW], col:'#6644aa',em:'ğŸ’¤',  fx:'ğŸ’¤ You step into other people\'s dreams! Mostly flying or forgetting exams.',sci:'ğŸ”¬ During REM sleep your brain is almost as active as when awake!'},
  {id:'dimension',   r:'epic',     n:'ğŸšª Dimension Door',     i:[BO,CR,EN], col:'#ff44ff',em:'ğŸšª',  fx:'ğŸšª A portal appears! It leads to a dimension made of jelly.',sci:'ğŸ”¬ String theory suggests there could be 11 dimensions!'},
  {id:'blackhole',   r:'epic',     n:'ğŸ•³ï¸ Black Hole Beverage',i:[DS,BW,CR], col:'#110022',em:'ğŸ•³ï¸',  fx:'ğŸ•³ï¸ A tiny black hole forms in your hand! It ate your homework.',sci:'ğŸ”¬ Black holes warp spacetime so severely not even light can escape!'},
  {id:'elements',    r:'epic',     n:'ğŸŒŠ Elemental Essence',  i:[LI,FT,DS], col:'#44aaff',em:'ğŸŒŠ',  fx:'ğŸŒŠ You control fire, water, earth and wind! Power is great, aim is challenging.',sci:'ğŸ”¬ Ancient Greeks believed in 4 elements â€” we now know of 118!'},
  {id:'mindctrl',    r:'epic',     n:'ğŸ® Mind Control Cocktail',i:[EN,MU,LI],col:'#ff3388',em:'ğŸ®',fx:'ğŸ® You control anyone like a video game character! Your dog goes wild.',sci:'ğŸ”¬ The zombie fungus Ophiocordyceps literally hijacks ant brains!'},
  {id:'timetravel',  r:'epic',     n:'â° Time Travel Tipple', i:[BO,CR,SD], col:'#ffaa00',em:'â°',  fx:'â° You travel 100 years into the future! Robots wave politely.',sci:'ğŸ”¬ Time dilation is real â€” GPS satellites must account for time in orbit!'},
  {id:'universe',    r:'epic',     n:'ğŸŒŒ Universe Viewer',    i:[BW,DS,SD], col:'#220044',em:'ğŸŒŒ',  fx:'ğŸŒŒ You see the entire universe simultaneously. Very humbling.',sci:'ğŸ”¬ The observable universe is 93 billion light-years across!'},
  // LEGENDARY (5)
  {id:'omnipotence', r:'legendary',n:'ğŸŒŸ Omnipotence Opus',   i:[SD,DS,CR], col:'#ff9900',em:'ğŸŒŸ',  fx:'ğŸŒŸ You become all-powerful for 3 seconds. You make perfect toast.',sci:'ğŸ”¬ The energy in 1g of matter (E=mcÂ²) equals a small city\'s daily power!'},
  {id:'creation',    r:'legendary',n:'âœ¨ Creation Cascade',    i:[DS,M,SW],  col:'#ffdd44',em:'âœ¨',  fx:'âœ¨ You create a planet! It\'s purple and rains toffee. You name it Gerald.',sci:'ğŸ”¬ Planets form from collapsing clouds of gas and dust around new stars!'},
  {id:'truemagic',   r:'legendary',n:'ğŸ”® True Magic Mastery', i:[M,CR,DS],  col:'#cc00ff',em:'ğŸ”®',  fx:'ğŸ”® You master magic! First spell turns the moon into a disco ball.',sci:'ğŸ”¬ "Any sufficiently advanced technology is indistinguishable from magic"!'},
  {id:'grandwitch',  r:'legendary',n:'ğŸ§™ Grand Witch Ascension',i:[BW,M,MU],col:'#ff6600',em:'ğŸ§™',  fx:'ğŸ§™ You become Grand Witch of the Universe! Cauldron is moon-sized.',sci:'ğŸ”¬ The largest known star UY Scuti is 1700x the size of our sun!'},
  {id:'bigbang',     r:'legendary',n:'ğŸ’¥ Big Bang Brew',       i:[DS,LI,M],  col:'#ff0000',em:'ğŸ’¥',  fx:'ğŸ’¥ You recreate the Big Bang in miniature! A new tiny universe waves hello.',sci:'ğŸ”¬ The Big Bang happened 13.8 billion years ago â€” all matter came from one point!'},
];


// Random recipe combos per game
function allCombos(){
  const ids=ING.map(x=>x.id),out=[];
  for(let a=0;a<ids.length;a++)
    for(let b=a+1;b<ids.length;b++)
      for(let c=b+1;c<ids.length;c++)
        out.push([ids[a],ids[b],ids[c]]);
  return out;
}
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
  return a;
}
function buildGameRecipes(){
  const combos=shuffle(allCombos());
  return RCP.map((r,idx)=>({...r,i:combos[idx]}));
}
let GAME_RCP=buildGameRecipes();

const MYSTERIES=[
  {em:'ğŸ¤¢',fx:'You turned green and burped a frog! He said hi and hopped away.'},
  {em:'ğŸº',fx:'Your nose turned into a tuba. Every breath plays a note.'},
  {em:'ğŸŒˆ',fx:'You sneeze rainbows for exactly 1 hour.'},
  {em:'ğŸ£',fx:'Three tiny chickens hatched from your armpits. They seem happy.'},
  {em:'ğŸª',fx:'Your shadow detached and started doing floss dances behind you.'},
  {em:'ğŸ•',fx:'You become pizza-scented. Dogs follow you everywhere.'},
  {em:'ğŸŒ',fx:'You move at snail speed! Very relaxing, very inconvenient.'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const store=(()=>{
  const m={};
  try{localStorage.setItem('_t','1');localStorage.removeItem('_t');return localStorage;}
  catch(e){return{getItem:k=>(k in m?m[k]:null),setItem:(k,v)=>{m[k]=v;},removeItem:k=>{delete m[k];}}}
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sel=[];           // current selected ingredients
let brewedInGame=new Set(); // potions brewed in this game session (no re-brewing)
let discovered=new Set(JSON.parse(store.getItem('disc3')||'[]'));
let score=0, streak=0, bestStreak=0, triesLeft=10, triesOnPotion=0;
let gameActive=true, curFilter='all', lbTabName='score', lastLbIdx=-1;

function hexToRgb(h){
  const c=(h||'#808080').replace('#','');
  return{r:parseInt(c.slice(0,2),16),g:parseInt(c.slice(2,4),16),b:parseInt(c.slice(4,6),16)};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEADERBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getLB(){try{return JSON.parse(store.getItem('lb3')||'[]');}catch{return[];}}
function saveLB(lb){store.setItem('lb3',JSON.stringify(lb));}
function addLBEntry(name,sc,found,bs){
  const lb=getLB();
  lb.push({name:name||'Anonymous Witch',score:sc,found,streak:bs,date:new Date().toLocaleDateString()});
  lb.sort((a,b)=>b.score-a.score);
  if(lb.length>20)lb.length=20;
  saveLB(lb);
  lastLbIdx=lb.findIndex(e=>e.name===name&&e.score===sc);
  renderLB();
}
function lbTab(t){
  lbTabName=t;
  document.getElementById('lbt-score').classList.toggle('on',t==='score');
  document.getElementById('lbt-found').classList.toggle('on',t==='found');
  renderLB();
}
function renderLB(){
  const lb=getLB();
  const body=document.getElementById('lb-body');
  if(!lb.length){body.innerHTML='<div class="lb-empty">No scores yet â€” finish a game!</div>';return;}
  const sorted=lbTabName==='found'?[...lb].sort((a,b)=>b.found-a.found||b.score-a.score):lb;
  const medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  body.innerHTML='<table><thead><tr><th>#</th><th>Witch</th><th>Score</th><th>Found</th><th>Streak</th><th>Date</th></tr></thead><tbody>'+
    sorted.slice(0,10).map((e,i)=>`<tr${i===lastLbIdx&&lbTabName==='score'?' class="me"':''}>`+
      `<td class="lb-rank">${medals[i]||(('#'+(i+1)))}</td>`+
      `<td class="lb-name">${esc(e.name)}</td>`+
      `<td class="lb-score">${(e.score||0).toLocaleString()}</td>`+
      `<td class="lb-sub">${e.found||0}/55</td>`+
      `<td class="lb-sub">${e.streak||0}ğŸ”¥</td>`+
      `<td class="lb-sub">${e.date||''}</td></tr>`).join('')+
  '</tbody></table>';
}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER INGREDIENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderIng(){
  const g=document.getElementById('igrid');
  g.innerHTML='';
  ING.forEach(ing=>{
    const b=document.createElement('button');
    b.className='ibtn'+(sel.includes(ing.id)?' sel':'');
    b.dataset.id=ing.id;
    if(!gameActive)b.classList.add('disabled-ing');
    b.innerHTML=`<span class="em">${ing.em}</span><span class="nm">${ing.name}</span><span class="tg ${ing.tc}">${ing.tag}</span>`;
    b.addEventListener('click',()=>addIng(ing.id));
    g.appendChild(b);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER SPELL BOOK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBook(){
  const list=document.getElementById('rlist');
  list.innerHTML='';
  GAME_RCP.filter(r=>curFilter==='all'||r.r===curFilter).forEach(r=>{
    const disc=discovered.has(r.id);
    const cfg=RARITY[r.r];
    const d=document.createElement('div');
    d.className='rc '+(disc?'disc '+r.r:'unk');
    d.innerHTML=`<span class="rtag ${r.r}">${cfg.em} ${cfg.label}</span>`+
      `<div class="rname">${disc?r.n:'??? Unknown Potion'}${disc?' <span style="color:var(--green);font-size:.65rem">âœ“</span>':''}</div>`+
      (disc?`<div class="rfx">${r.fx}</div>`:'')+
      `<div class="rhint">${disc?'+'+cfg.base+' base pts':'Needs 3 ingredients'}</div>`;
    list.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHud(){
  document.getElementById('h-score').textContent=score.toLocaleString();
  document.getElementById('h-streak').textContent='Ã—'+Math.min(4,1+streak*.5).toFixed(1).replace('.0','');
  document.getElementById('h-tries').textContent=triesLeft;
  document.getElementById('sb-found').textContent=discovered.size+'/55';
  document.getElementById('h-streak-b').classList.toggle('on',streak>=1);
  document.getElementById('h-tries-b').classList.toggle('danger',triesLeft<=5);
  document.getElementById('xpfill').style.width=((discovered.size%5)/5*100)+'%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD INGREDIENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addIng(id){
  if(!gameActive) return;
  // If already selected â€” deselect/remove it
  if(sel.includes(id)){
    sel=sel.filter(x=>x!==id);
    const btn=document.querySelector(`.ibtn[data-id="${id}"]`);
    if(btn) btn.classList.remove('sel');
    updateCauldronSlots();
    document.getElementById('brew-btn').disabled=sel.length<3;
    updateLiquid();updateGlow();
    playSound('clear');
    return;
  }
  if(sel.length>=3){ shakeCauldron(); return; }
  sel.push(id);
  const ing=ING.find(x=>x.id===id);
  // Visual feedback on button
  const btn=document.querySelector(`.ibtn[data-id="${id}"]`);
  if(btn){ btn.classList.add('sel'); flyIng(btn,ing.em); playSound('add'); }
  // Cauldron effects
  setTimeout(()=>{ spawnMist(ing.col); spawnMist(ing.col); spawnStir(ing.col); },350);
  addBub(ing.col);addBub(ing.col);addBub(ing.col);
  updateLiquid();
  updateGlow();
  // Update slot display
  updateCauldronSlots();
  document.getElementById('brew-btn').disabled = sel.length < 3;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLEAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearCauldron(){
  sel=[];
  updateCauldronSlots();
  document.getElementById('brew-btn').disabled=true;
  updateLiquid();
  updateGlow();
  renderIng();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAULDRON SLOTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateCauldronSlots(){
  for(let i=0;i<3;i++){
    const slot=document.getElementById('cslot-'+i);
    if(!slot) continue;
    const ingId=sel[i];
    const emEl=slot.querySelector('.cslot-em');
    if(ingId){
      const ing=ING.find(x=>x.id===ingId);
      // force reflow to retrigger animation
      emEl.textContent='';
      slot.classList.remove('filled','empty-slot');
      void slot.offsetWidth;
      emEl.textContent=ing.em;
      slot.classList.add('filled');
      slot.style.borderColor=ing.col;
      slot.style.background=ing.col+'22';
      slot.style.boxShadow=`0 0 14px ${ing.col}66`;
    } else {
      emEl.textContent='';
      slot.classList.remove('filled');
      slot.classList.add('empty-slot');
      slot.style.borderColor='';
      slot.style.background='';
      slot.style.boxShadow='';
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BREW SWIRL EFFECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function brewSwirlEffect(onDone){
  const {x:cx,y:cy}=cwCenter();
  const slots=document.querySelectorAll('.cslot.filled');
  let count=slots.length;
  if(count===0){onDone&&onDone();return;}
  slots.forEach((slot,i)=>{
    const r=slot.getBoundingClientRect();
    const startX=r.left+r.width/2;
    const startY=r.top+r.height/2;
    const em=slot.querySelector('.cslot-em').textContent;
    const el=document.createElement('div');
    el.className='brew-swirl';
    el.textContent=em;
    el.style.cssText=`left:${startX}px;top:${startY}px;`;
    document.body.appendChild(el);
    const delay=i*120;
    setTimeout(()=>{
      // Animate toward cauldron center with swirl
      const duration=600;
      const startTime=performance.now();
      function frame(now){
        const t=Math.min((now-startTime)/duration,1);
        const ease=t<0.5?2*t*t:1-Math.pow(-2*t+2,2)/2;
        const curX=startX+(cx-startX)*ease;
        const curY=startY+(cy-startY)*ease;
        const rot=t*540;
        const scale=1-t*0.9;
        const opacity=t>0.7?1-(t-0.7)/0.3:1;
        el.style.left=curX+'px';
        el.style.top=curY+'px';
        el.style.transform=`translate(-50%,-50%) scale(${scale}) rotate(${rot}deg)`;
        el.style.opacity=opacity;
        if(t<1){requestAnimationFrame(frame);}
        else{
          el.remove();
          count--;
          // Spawn dissolve flash at cauldron
          const flash=document.createElement('div');
          flash.style.cssText=`position:fixed;left:${cx}px;top:${cy}px;font-size:1.6rem;transform:translate(-50%,-50%);pointer-events:none;z-index:201;animation:dissolve .5s forwards;`;
          flash.textContent=em;
          document.body.appendChild(flash);
          setTimeout(()=>flash.remove(),500);
          if(count===0&&onDone)setTimeout(onDone,200);
        }
      }
      requestAnimationFrame(frame);
    },delay);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BREW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Witch brew sequence helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WITCH_LINES=[
  'Hee hee hee! âœ¨','By the moon! ğŸŒ•','Stir stir stir! ğŸŒ€',
  'Double bubble! ğŸ«§','Ancient magic! âš¡','Yes yes YES! ğŸ”®',
  'Mmm smells... odd ğŸ¤”','Something stirs... ğŸ‘€'
];
const FAIL_LINES=["That's not right... ğŸ˜¬","Hmm, not quite! ğŸ¤”","Wrong mix! ğŸ’¥","Nope! Try again! ğŸ˜…","That smells bad! ğŸ¤¢"];

let witchScrollHandler = null;

function positionWitch(cRect){
  const w=document.getElementById('witch-wrap');
  const wx = cRect.left - 10;
  const wy = cRect.top - 10;
  w.style.left = wx+'px';
  w.style.top  = wy+'px';
}

function startWitchScrollTracking(){
  stopWitchScrollTracking();
  witchScrollHandler = ()=>{
    const cRect = document.getElementById('cw').getBoundingClientRect();
    positionWitch(cRect);
    // Also reposition speech bubble if visible
    const b = document.getElementById('witch-bubble');
    if(b.classList.contains('show')){
      const w = document.getElementById('witch-wrap');
      const wr = w.getBoundingClientRect();
      b.style.left=(wr.left+35)+'px';
      b.style.top =(wr.top-44)+'px';
    }
  };
  window.addEventListener('scroll', witchScrollHandler, {passive:true});
}

function stopWitchScrollTracking(){
  if(witchScrollHandler){
    window.removeEventListener('scroll', witchScrollHandler);
    witchScrollHandler = null;
  }
}

function showWitchBubble(text, wx, wy){
  const b=document.getElementById('witch-bubble');
  b.textContent=text;
  b.style.left=(wx-30)+'px';
  b.style.top =(wy-44)+'px';
  b.classList.add('show');
}
function hideWitchBubble(){
  document.getElementById('witch-bubble').classList.remove('show');
}

function bigSmokePuff(cx,cy,col1,col2,size){
  // Multiple layered smoke puffs that bloom and fade
  const cols=[col1,col2,col1];
  cols.forEach((c,i)=>{
    const el=document.createElement('div');
    el.className='brew-smoke';
    const sz=size*(0.6+i*.25);
    const ox=(Math.random()-.5)*40*(i+1), oy=(Math.random()-.5)*30*(i+1)-i*20;
    el.style.cssText=`width:${sz}px;height:${sz*0.7}px;`+
      `background:radial-gradient(ellipse at 50% 60%,${c}ee 0%,${c}88 40%,transparent 75%);`+
      `left:${cx+ox}px;top:${cy+oy}px;`+
      `animation-duration:${1.4+i*.3}s;animation-delay:${i*.12}s;`;
    document.body.appendChild(el);
    setTimeout(()=>{try{el.remove();}catch(e){}}, 2200);
  });
}

function cauldronGlowReveal(cx,cy,col,size){
  const el=document.getElementById('cw-glow-reveal');
  el.style.width=size+'px';
  el.style.height=size+'px';
  el.style.left=cx+'px';
  el.style.top=cy+'px';
  el.style.background=`radial-gradient(circle,${col}cc 0%,${col}66 40%,transparent 75%)`;
  el.style.boxShadow=`0 0 60px 20px ${col}88`;
  el.classList.remove('pulse');
  void el.offsetWidth;
  el.classList.add('pulse');
  // Also flash the SVG
  try{
    const svg=document.querySelector('.cw svg');
    svg.style.filter=`drop-shadow(0 0 40px ${col}) drop-shadow(0 0 80px ${col})`;
    setTimeout(()=>{ svg.style.transition='filter 1.2s ease'; svg.style.filter='none'; setTimeout(()=>{svg.style.transition='';},1300); },200);
  }catch(e){}
}

function brew(){
  if(!gameActive) return;
  if(sel.length<3) return;

  // Check if this combo was already brewed this game
  const sortedCheck=[...sel].sort();
  const comboKeyCheck='combo:'+sortedCheck.join(',');
  const alreadyBrewed=brewedInGame.has(comboKeyCheck)||GAME_RCP.find(r=>{
    const s=[...r.i].sort();
    return s.length===sortedCheck.length&&s.every((v,i)=>v===sortedCheck[i])&&brewedInGame.has(r.id);
  });
  if(alreadyBrewed){
    // Shake cauldron and show a message
    shakeCauldron();
    const btn=document.getElementById('brew-btn');
    const orig=btn.textContent;
    btn.textContent='âš—ï¸ Already brewed!';
    btn.disabled=true;
    setTimeout(()=>{btn.textContent=orig;btn.disabled=sel.length<3;},1800);
    return;
  }

  // Lock inputs during sequence
  document.getElementById('brew-btn').disabled=true;

  triesOnPotion++;
  triesLeft--;
  updateHud();

  const sorted=[...sel].sort();
  const matched=GAME_RCP.find(r=>{const s=[...r.i].sort();return s.length===sorted.length&&s.every((v,i)=>v===sorted[i]);});
  const snap=[...sel];
  const comboKey='combo:'+sorted.join(','); // key for tracking brewed combos this game
  const cRect=document.getElementById('cw').getBoundingClientRect();
  const cx=cRect.left+cRect.width/2, cy=cRect.top+cRect.height/2;

  const rColors={common:'#aaaaaa',rare:'#4488ff',epic:'#cc44ff',legendary:'#ff9900'};
  const smokeCol = matched ? rColors[matched.r] : '#333344';
  const smokeCol2 = matched ? (matched.col||smokeCol) : '#554466';

  // â”€â”€ PHASE 1 (0s): bubbles + witch flies in â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sel.forEach(id=>{ const ing=ING.find(x=>x.id===id); for(let k=0;k<5;k++) setTimeout(()=>addBub(ing.col),k*90); });
  spawnStir(ING.find(x=>x.id===sel[0]).col);

  positionWitch(cRect);
  startWitchScrollTracking();
  const ww=document.getElementById('witch-wrap');
  ww.classList.remove('fly-in','brew-stir','fly-out');
  void ww.offsetWidth;
  ww.classList.add('fly-in');

  // â”€â”€ PHASE 2 (0.55s): witch stirs, speech bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setTimeout(()=>{
    ww.classList.remove('fly-in'); ww.style.opacity='1';
    document.getElementById('witch-arm').classList.add('stirring');
    document.getElementById('witch-hat').classList.add('bobbing');
    const line = matched
      ? WITCH_LINES[Math.floor(Math.random()*WITCH_LINES.length)]
      : FAIL_LINES[Math.floor(Math.random()*FAIL_LINES.length)];
    const wr=ww.getBoundingClientRect();
    showWitchBubble(line, wr.left+65, wr.top+10);
    // More bubbles while stirring
    for(let k=0;k<8;k++) setTimeout(()=>{
      sel.forEach(id=>{const ing=ING.find(x=>x.id===id);if(ing)addBub(ing.col);});
      spawnStir(ING.find(x=>x.id===sel[0]).col);
    }, k*120);
  }, 560);

  // â”€â”€ PHASE 3 (1.5s): BIG smoke billows up â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setTimeout(()=>{
    hideWitchBubble();
    // Three waves of big smoke
    bigSmokePuff(cx, cy, smokeCol,  smokeCol2, 220);
    setTimeout(()=>bigSmokePuff(cx-30, cy-20, smokeCol2, smokeCol,  180), 120);
    setTimeout(()=>bigSmokePuff(cx+20, cy-30, smokeCol,  '#ffffff44', 200), 240);
    // Cauldron shake/tilt during smoke
    const cwEl=document.getElementById('cw');
    cwEl.classList.remove('ctilt'); void cwEl.offsetWidth; cwEl.classList.add('ctilt');
    setTimeout(()=>cwEl.classList.remove('ctilt'),900);
    // Flash liquid
    try{
      const liq=document.getElementById('brew-liquid');
      liq.style.transition='fill .1s';
      liq.setAttribute('fill', matched ? matched.col : '#330033');
      setTimeout(()=>{liq.style.transition='fill 2s ease';},200);
    }catch(e){}
  }, 1500);

  // â”€â”€ PHASE 4 (2.1s): witch flies out â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setTimeout(()=>{
    document.getElementById('witch-arm').classList.remove('stirring');
    document.getElementById('witch-hat').classList.remove('bobbing');
    ww.classList.add('fly-out');
    setTimeout(()=>{ ww.style.opacity='0'; ww.classList.remove('fly-out'); stopWitchScrollTracking(); },500);
  }, 2100);

  // â”€â”€ PHASE 5 (2.5s): rarity glow reveal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setTimeout(()=>{
    const glowCol = matched ? rColors[matched.r] : '#220033';
    cauldronGlowReveal(cx, cy, glowCol, 300);
    if(matched){
      // Extra effects for rarer potions
      if(matched.r!=='common'){ doLightning(glowCol,cRect); setTimeout(()=>doLightning(matched.col,cRect),250); }
      if(matched.r==='legendary'){ setTimeout(()=>doLightning('#fff',cRect),500); }
      const rn={common:2,rare:4,epic:7,legendary:11}[matched.r];
      spawnRunes(glowCol,rn);
      for(let k=0;k<4;k++) setTimeout(()=>spawnMist(glowCol),k*80);
    }
  }, 2500);

  // â”€â”€ PHASE 6 (3.1s): show result modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setTimeout(()=>{
    // Unlock inputs
    brewedInGame.add(comboKey); // mark this combo as used this game
    showResult(matched, snap);
  }, 3100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOW RESULT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showResult(recipe,snap){
  const isNew=recipe&&!discovered.has(recipe.id);
  document.getElementById('new-badge').style.display='none';
  document.getElementById('res-pts').style.display='none';
  if(!recipe){
    streak=0; updateHud();
    const m=MYSTERIES[Math.floor(Math.random()*MYSTERIES.length)];
    document.getElementById('res-em').textContent=m.em;
    document.getElementById('res-name').textContent='â“ Mystery Brew! (streak reset)';
    document.getElementById('res-name').style.color='#ff3333';
    document.getElementById('res-rar').innerHTML='<span style="color:#ff6666">ğŸ’¥ Wrong combo!</span>';
    document.getElementById('res-fx').textContent=m.fx;
    document.getElementById('res-sci').innerHTML='<strong>ğŸ”¬ Tip:</strong> Mystery brews reset your streak â€” and this combo won\'t work again this game!';
    document.getElementById('res-strip').style.background='linear-gradient(90deg,'+snap.map(id=>ING.find(x=>x.id===id).col).join(',')+')'
  } else {
    discovered.add(recipe.id);
    brewedInGame.add(recipe.id);
    store.setItem('disc3',JSON.stringify([...discovered]));
    const cfg=RARITY[recipe.r];
    document.getElementById('res-em').textContent=recipe.em;
    document.getElementById('res-name').textContent=recipe.n;
    document.getElementById('res-name').style.color=cfg.color;
    document.getElementById('res-rar').innerHTML=`<span class="rtag ${recipe.r}" style="float:none;display:inline-block">${cfg.em} ${cfg.label}</span>`;
    document.getElementById('res-fx').textContent=recipe.fx;
    document.getElementById('res-sci').innerHTML=recipe.sci;
    document.getElementById('res-strip').style.background=`linear-gradient(90deg,${recipe.col},white,${recipe.col})`;
    if(isNew){
      const pts=calcPts(recipe.r,triesOnPotion);
      streak++; if(streak>bestStreak)bestStreak=streak;
      score+=pts.total; updateHud();
      _wbCheckMidGame(recipe);
      const ml=pts.mult===1?'Ã—1 (start a streak!)':'Ã—'+pts.mult+' ('+streak+' in a row! ğŸ”¥)';
      const tl=triesOnPotion===1?'1st try! ğŸ¯':triesOnPotion+' tries';
      document.getElementById('res-pts').innerHTML=
        `<div class="pr"><span>Base (${cfg.label})</span><span>+${pts.base}</span></div>`+
        `<div class="pr"><span>âš¡ Speed bonus (${tl})</span><span>+${pts.spd}</span></div>`+
        `<div class="pr"><span>ğŸ”¥ Streak mult</span><span>${ml}</span></div>`+
        `<div class="pr ptot"><span>âœ¨ Total earned</span><span>+${pts.total}!</span></div>`;
      document.getElementById('res-pts').style.display='block';
      document.getElementById('new-badge').style.display='block';
      const cw=document.getElementById('cw');
      const r=cw.getBoundingClientRect();
      spawnFpts('+'+pts.total,r.left+r.width/2,r.top+20);
      spawnConfetti(recipe.r);
      triesOnPotion=0;
    }
  }
  renderBook();
  // Green border for success, red border for failure
  const resCard = document.querySelector('#res-ovl .card');
  resCard.style.borderColor = recipe ? '#00cc44' : '#ff3333';
  resCard.style.boxShadow   = recipe ? '0 0 50px rgba(0,204,68,.4)' : '0 0 50px rgba(255,51,51,.5)';
  document.getElementById('res-ovl').classList.add('show');
  // Play sound
  if(recipe){ playSound(recipe.r==='legendary'?'legendary':'success'); } else { playSound('fail'); }
  // Auto-close: 8s for success, 5s for fail. If game just ended, close sooner and show game over.
  const autoDelay = triesLeft<=0 ? 2000 : (recipe ? 10000 : 5000);
  startResAutoClose(recipe && triesLeft>0);
  if(triesLeft<=0){
    clearTimeout(resAutoCloseTimer);
    resAutoCloseTimer=setTimeout(()=>{
      document.getElementById('res-ovl').classList.remove('show');
      clearCauldron();
      endGame();
    }, 2000);
  }
}

function calcPts(rar,tries){
  const cfg=RARITY[rar];
  const spd=Math.max(0,Math.round(cfg.spd/tries));
  const mult=Math.min(4,1+streak*.5);
  return{base:cfg.base,spd,mult,total:Math.round((cfg.base+spd)*mult)};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// END GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function endGame(){
  gameActive=false;
  renderIng(); // re-render with disabled-ing class
  document.getElementById('brew-btn').disabled=true;
  const rc={common:0,rare:0,epic:0,legendary:0};
  discovered.forEach(id=>{const r=GAME_RCP.find(x=>x.id===id);if(r)rc[r.r]=(rc[r.r]||0)+1;});
  document.getElementById('go-score').textContent=score.toLocaleString();
  document.getElementById('go-found').textContent=discovered.size;
  document.getElementById('go-streak').textContent=bestStreak;
  document.getElementById('go-common').textContent=rc.common;
  document.getElementById('go-rare').textContent=rc.rare;
  document.getElementById('go-epic').textContent=rc.epic;
  document.getElementById('go-legendary').textContent=rc.legendary;
  document.getElementById('gameover-ovl').classList.add('show');
  playSound('gameover');
  awardWitchBrewEndBadges();
}

function resetGame(){
  sel=[];score=0;streak=0;bestStreak=0;triesLeft=10;triesOnPotion=0;
  gameActive=true;lastLbIdx=-1;brewedInGame=new Set();
  // Discovered recipes persist across games â€” saved in localStorage
  GAME_RCP=buildGameRecipes();
  document.getElementById('confirm-ovl').classList.remove('show');
  document.getElementById('save-btn').disabled=false;
  document.getElementById('save-btn').textContent='ğŸ† Save to Leaderboard!';
  document.getElementById('gameover-ovl').classList.remove('show');
  document.getElementById('res-ovl').classList.remove('show');
  document.getElementById('player-name').value='';
  cancelResAutoClose();
  clearCauldron();updateHud();renderBook();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAULDRON HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateLiquid(){
  const liq=document.getElementById('brew-liquid');
  if(!sel.length){liq.setAttribute('fill','#1a4a1a');return;}
  let r=0,g=0,b=0;
  sel.forEach(id=>{const ing=ING.find(x=>x.id===id);const c=hexToRgb(ing.col);r+=c.r;g+=c.g;b+=c.b;});
  liq.setAttribute('fill',`rgb(${r/sel.length|0},${g/sel.length|0},${b/sel.length|0})`);
}
function updateGlow(){
  const glow=document.getElementById('brew-glow');
  const n=sel.length;
  if(!n){glow.style.background='rgba(57,255,20,.2)';glow.style.width='100px';glow.style.height='28px';return;}
  const ing=ING.find(x=>x.id===sel[sel.length-1]);
  const c=hexToRgb(ing.col);
  glow.style.background=`rgba(${c.r},${c.g},${c.b},.5)`;
  glow.style.width=(80+n*25)+'px';
  glow.style.height=(20+n*8)+'px';
}
function addBub(col){
  const c=document.getElementById('bub-c');
  const b=document.createElement('div');
  b.className='bub';
  const sz=6+Math.random()*10,left=25+Math.random()*120,dur=1.2+Math.random()*1.5;
  b.style.cssText=`width:${sz}px;height:${sz}px;background:${col};left:${left}px;bottom:32px;animation-duration:${dur}s;box-shadow:0 0 4px ${col};`;
  c.appendChild(b);
  setTimeout(()=>b.remove(),(dur+.1)*1000);
}
function shakeCauldron(){
  const cw=document.getElementById('cw');
  cw.classList.remove('cshake');void cw.offsetWidth;cw.classList.add('cshake');
  setTimeout(()=>cw.classList.remove('cshake'),500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUAL EFFECTS â€” all fixed position, pointer-events:none
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cwCenter(){
  const r=document.getElementById('cw').getBoundingClientRect();
  return{x:r.left+r.width/2,y:r.top+r.height/2,r};
}
function mkFx(cls,css,life){
  const el=document.createElement('div');
  el.className=cls;el.style.cssText=css;
  document.body.appendChild(el);
  setTimeout(()=>{try{el.remove();}catch(e){}},life||1500);
  return el;
}
function flyIng(btn,em){
  try{
    const br=btn.getBoundingClientRect();
    const {x,y}=cwCenter();
    const el=document.createElement('div');
    el.className='ing-fly';
    el.textContent=em;
    el.style.left=br.left+br.width/2+'px';
    el.style.top=br.top+br.height/2+'px';
    el.style.transform='translate(-50%,-50%)';
    el.style.opacity='1';
    document.body.appendChild(el);
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      el.style.left=x+'px';el.style.top=y+'px';
      el.style.transform='translate(-50%,-50%) scale(0) rotate(360deg)';
      el.style.opacity='0';
    }));
    setTimeout(()=>{try{el.remove();}catch(e){}},500);
  }catch(e){}
}
function spawnMist(col){
  const {x,y}=cwCenter();
  const mx=(Math.random()-.5)*80+'px';
  mkFx('fx-mist',`width:30px;height:30px;background:radial-gradient(circle,${col}66 0%,transparent 70%);left:${x}px;top:${y-10}px;--mx:${mx};animation-duration:${1.5+Math.random()}s;`,2600);
}
function spawnStir(col){
  const {x,y}=cwCenter();
  mkFx('fx-ring',`width:110px;height:38px;border:2px solid ${col};box-shadow:0 0 8px ${col};left:${x}px;top:${y}px;animation-duration:.75s;`,800);
}
function spawnSmoke(col,cx,cy){
  for(let k=0;k<7;k++){
    const sz=25+Math.random()*40,ox=(Math.random()-.5)*70,oy=(Math.random()-.5)*60;
    mkFx('fx-smoke',`width:${sz}px;height:${sz}px;background:radial-gradient(circle,${col}55 0%,transparent 70%);left:${cx+ox}px;top:${cy+oy}px;animation-duration:${.7+Math.random()*.5}s;animation-delay:${Math.random()*.12}s;`,1400);
  }
}
const RUNES='áš áš¢áš¦áš¨áš±áš²áš·áš¹ášºáš¾á›á›ƒá›‡á›ˆá›‰á›Šá›á›’á›–á›—á›šá›œá›á›Ÿ';
function spawnRunes(col,n){
  const {x,y}=cwCenter();
  for(let k=0;k<n;k++){
    const rd=65+Math.random()*20;
    const el=mkFx('fx-rune',`left:${x}px;top:${y}px;color:${col};text-shadow:0 0 8px ${col};--rd:${rd}px;animation-duration:${1.4+Math.random()*.4}s;`,2000);
    el.textContent=RUNES[Math.floor(Math.random()*RUNES.length)];
    el.style.animationDelay=(k*0.05)+'s';
  }
}
function spawnBottle(col){
  const {x,y}=cwCenter();
  const bottles=['ğŸ§ª','âš—ï¸','ğŸ«™','ğŸ¶'];
  mkFx('fx-bottle',`left:${x}px;top:${y}px;filter:drop-shadow(0 0 10px ${col});animation-duration:1s;`,1100).textContent=bottles[Math.floor(Math.random()*bottles.length)];
}
function spawnFpts(txt,x,y){
  mkFx('fpts',`left:${x}px;top:${y}px;transform:translateX(-50%);`,1500).textContent=txt;
}
function spawnConfetti(rar){
  const sets={common:['â­','âœ¨','âšª'],rare:['ğŸ”µ','ğŸ’™','â­','âœ¨'],epic:['ğŸŸ£','ğŸ’œ','ğŸŒŸ','âœ¨'],legendary:['ğŸŒŸ','ğŸ†','ğŸ’¥','ğŸ”¥','ğŸ‘‘','ğŸ‰','â­']};
  const ems=sets[rar]||sets.common;
  const n={common:10,rare:16,epic:24,legendary:40}[rar]||10;
  for(let k=0;k<n;k++){
    const el=mkFx('cf-piece',`left:${Math.random()*100}vw;animation-duration:${2+Math.random()*2}s;animation-delay:${Math.random()*.4}s;font-size:${1+Math.random()}rem;`,4500);
    el.textContent=ems[Math.floor(Math.random()*ems.length)];
  }
}
function doLightning(col,cRect){
  try{
    const cv=document.getElementById('lightning-canvas');
    cv.style.left=cRect.left+'px';cv.style.top=cRect.top+'px';
    cv.width=Math.round(cRect.width);cv.height=Math.round(cRect.height);
    const ctx=cv.getContext('2d');
    ctx.clearRect(0,0,cv.width,cv.height);
    function bolt(x1,y1,x2,y2,d){
      if(d<=0)return;
      const mx=(x1+x2)/2+(Math.random()-.5)*25,my=(y1+y2)/2+(Math.random()-.5)*15;
      ctx.beginPath();ctx.moveTo(x1,y1);ctx.quadraticCurveTo(mx,my,x2,y2);
      ctx.strokeStyle=col;ctx.lineWidth=d*.8;ctx.shadowColor=col;ctx.shadowBlur=6;ctx.stroke();
      if(Math.random()>.5)bolt(mx,my,mx+(Math.random()-.5)*35,my-15-Math.random()*20,d-1);
    }
    const nb=4+Math.floor(Math.random()*3);
    for(let k=0;k<nb;k++){
      const a=(k/nb)*Math.PI*2;
      bolt(cv.width/2+52*Math.cos(a),cv.height/2+17*Math.sin(a),cv.width/2+(Math.random()-.5)*50,10+Math.random()*30,3);
    }
    let f=0,fi=setInterval(()=>{cv.style.opacity=f%2?'1':'0';if(++f>5){clearInterval(fi);ctx.clearRect(0,0,cv.width,cv.height);cv.style.opacity='1';}},80);
  }catch(e){}
}
function doBrewEffect(recipe,cRect){
  const rcols={common:'#aaa',rare:'#4488ff',epic:'#cc44ff',legendary:'#ff9900'};
  const col=rcols[recipe.r];
  const cx=cRect.left+cRect.width/2,cy=cRect.top+cRect.height/2;
  // Tilt
  const cw=document.getElementById('cw');
  cw.classList.remove('ctilt');void cw.offsetWidth;cw.classList.add('ctilt');
  setTimeout(()=>cw.classList.remove('ctilt'),950);
  // Flash liquid
  try{const liq=document.getElementById('brew-liquid');liq.style.transition='fill .1s';liq.setAttribute('fill',recipe.col);setTimeout(()=>{liq.style.transition='fill 1.5s ease';},200);}catch(e){}
  // SVG glow
  try{const svg=document.querySelector('.cw svg');svg.style.filter=`drop-shadow(0 0 30px ${col}) drop-shadow(0 0 60px ${col})`;setTimeout(()=>{svg.style.filter='none';},1200);}catch(e){}
  // Rings
  spawnStir(col);setTimeout(()=>spawnStir(recipe.col),200);
  if(recipe.r==='epic'||recipe.r==='legendary')setTimeout(()=>spawnStir(col),400);
  // Lightning
  if(recipe.r!=='common'){doLightning(col,cRect);setTimeout(()=>doLightning(recipe.col,cRect),300);}
  if(recipe.r==='legendary')setTimeout(()=>doLightning('#fff',cRect),600);
  // Smoke
  spawnSmoke(col,cx,cy);setTimeout(()=>spawnSmoke(recipe.col,cx,cy),200);
  // Runes
  const rn={common:3,rare:5,epic:8,legendary:12}[recipe.r];
  setTimeout(()=>spawnRunes(col,rn),100);
  if(recipe.r==='legendary')setTimeout(()=>spawnRunes('#fff',5),400);
  // Bottle
  setTimeout(()=>spawnBottle(col),450);
  // Mist
  for(let k=0;k<5;k++)setTimeout(()=>spawnMist(col),k*80);
  for(let k=0;k<3;k++)setTimeout(()=>spawnMist(recipe.col),200+k*100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOUND EFFECTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx=null;
function getAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx;}
function playSound(type){
  try{
    const ac=getAudio();
    if(type==='add'){
      const o=ac.createOscillator(),g=ac.createGain();o.connect(g);g.connect(ac.destination);
      o.type='sine';o.frequency.setValueAtTime(440+sel.length*80,ac.currentTime);
      g.gain.setValueAtTime(0.1,ac.currentTime);g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+0.15);
      o.start(ac.currentTime);o.stop(ac.currentTime+0.15);
    }else if(type==='brew'){
      [300,350,280,400].forEach((f,i)=>{
        const o=ac.createOscillator(),g=ac.createGain();o.connect(g);g.connect(ac.destination);
        o.type='sine';o.frequency.setValueAtTime(f,ac.currentTime+i*0.12);
        g.gain.setValueAtTime(0.12,ac.currentTime+i*0.12);g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+i*0.12+0.25);
        o.start(ac.currentTime+i*0.12);o.stop(ac.currentTime+i*0.12+0.25);
      });
    }else if(type==='success'){
      [523,659,784,1047].forEach((f,i)=>{
        const o=ac.createOscillator(),g=ac.createGain();o.connect(g);g.connect(ac.destination);
        o.type='triangle';o.frequency.setValueAtTime(f,ac.currentTime+i*0.1);
        g.gain.setValueAtTime(0.13,ac.currentTime+i*0.1);g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+i*0.1+0.4);
        o.start(ac.currentTime+i*0.1);o.stop(ac.currentTime+i*0.1+0.4);
      });
    }else if(type==='legendary'){
      [523,659,784,1047,1318].forEach((f,i)=>{
        const o=ac.createOscillator(),g=ac.createGain();o.connect(g);g.connect(ac.destination);
        o.type='triangle';o.frequency.setValueAtTime(f,ac.currentTime+i*0.12);
        g.gain.setValueAtTime(0.15,ac.currentTime+i*0.12);g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+i*0.12+0.5);
        o.start(ac.currentTime+i*0.12);o.stop(ac.currentTime+i*0.12+0.5);
      });
    }else if(type==='fail'){
      const o=ac.createOscillator(),g=ac.createGain();o.connect(g);g.connect(ac.destination);
      o.type='sawtooth';o.frequency.setValueAtTime(220,ac.currentTime);
      o.frequency.linearRampToValueAtTime(140,ac.currentTime+0.25);
      g.gain.setValueAtTime(0.1,ac.currentTime);g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+0.3);
      o.start(ac.currentTime);o.stop(ac.currentTime+0.3);
    }else if(type==='clear'){
      const o=ac.createOscillator(),g=ac.createGain();o.connect(g);g.connect(ac.destination);
      o.type='sine';o.frequency.setValueAtTime(300,ac.currentTime);
      o.frequency.linearRampToValueAtTime(180,ac.currentTime+0.2);
      g.gain.setValueAtTime(0.08,ac.currentTime);g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+0.25);
      o.start(ac.currentTime);o.stop(ac.currentTime+0.25);
    }else if(type==='gameover'){
      [400,350,300,250].forEach((f,i)=>{
        const o=ac.createOscillator(),g=ac.createGain();o.connect(g);g.connect(ac.destination);
        o.type='sawtooth';o.frequency.setValueAtTime(f,ac.currentTime+i*0.18);
        g.gain.setValueAtTime(0.12,ac.currentTime+i*0.18);g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+i*0.18+0.35);
        o.start(ac.currentTime+i*0.18);o.stop(ac.currentTime+i*0.18+0.35);
      });
    }
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-CLOSE TIMERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let resAutoCloseTimer=null;

function startResAutoClose(isSuccess){
  clearTimeout(resAutoCloseTimer);
  const delay=isSuccess?10000:5000;
  resAutoCloseTimer=setTimeout(()=>{
    const ovl=document.getElementById('res-ovl');
    if(ovl.classList.contains('show')){
      ovl.classList.remove('show');
      clearCauldron();
      if(triesLeft<=0)endGame();
    }
  },delay);
}

function cancelResAutoClose(){
  clearTimeout(resAutoCloseTimer);
  resAutoCloseTimer=null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BADGE ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BADGE_DEF={
  md_first:{game:'mathdive',em:'ğŸ¤¿',name:'First Dive',desc:'Complete your first Math Dive game'},
  md_sharp:{game:'mathdive',em:'â­',name:'Sharp Shooter',desc:'Score 10+ correct answers in one game'},
  md_fire:{game:'mathdive',em:'ğŸ”¥',name:'On Fire',desc:'Reach a 5Ã— streak in Math Dive'},
  md_speed:{game:'mathdive',em:'âš¡',name:'Speed Demon',desc:'Score 15+ correct answers in one game'},
  md_legend:{game:'mathdive',em:'ğŸ†',name:'Legendary Diver',desc:'Score 20+ correct answers in one game'},
  md_times:{game:'mathdive',em:'ğŸ§®',name:'Times Master',desc:'Complete a game on the Ages 9â€“10 level'},
  jw_first:{game:'junglewords',em:'ğŸ¦',name:'First Words',desc:'Complete your first Jungle Words game'},
  jw_builder:{game:'junglewords',em:'ğŸ“',name:'Sentence Builder',desc:'Build 5+ correct sentences in one game'},
  jw_wizard:{game:'junglewords',em:'ğŸŒŸ',name:'Word Wizard',desc:'Finish a game without losing a life'},
  jw_elite:{game:'junglewords',em:'ğŸ…',name:'Explorer Elite',desc:'Score 8/8 sentences in one game'},
  wb_first:{game:'witchbrew',em:'ğŸ§™â€â™€ï¸',name:'Apprentice Witch',desc:'Brew your first successful potion'},
  wb_rare:{game:'witchbrew',em:'ğŸ”µ',name:'Rare Find',desc:'Discover a Rare potion'},
  wb_epic:{game:'witchbrew',em:'ğŸŸ£',name:'Epic Brewer',desc:'Discover an Epic potion'},
  wb_legend:{game:'witchbrew',em:'ğŸŸ ',name:'Legendary!',desc:'Discover a Legendary potion'},
  wb_collect:{game:'witchbrew',em:'ğŸ“–',name:'Spell Collector',desc:'Discover 10 or more potions total'},
  wb_streak:{game:'witchbrew',em:'ğŸ”¥',name:'On A Roll',desc:'Achieve a 3Ã— brew streak'},
  ts_first:{game:'tubesort',em:'ğŸ§ª',name:'First Sort',desc:'Complete Level 1 of Tube Sort'},
  ts_perfect:{game:'tubesort',em:'ğŸ’',name:'Perfectionist',desc:'Complete a level earning 3 stars'},
  ts_speed:{game:'tubesort',em:'âš¡',name:'Speed Sorter',desc:'Complete Level 5 or beyond'},
  ts_master:{game:'tubesort',em:'ğŸ‘‘',name:'Tube Master',desc:'Reach Level 10 in Tube Sort'},
  cg_fan:{game:'crabcake',em:'ğŸ¦€',name:'Crabcake Fan',desc:'Play all 4 Crabcake games at least once'},
  cg_allround:{game:'crabcake',em:'ğŸŒŸ',name:'All-Rounder',desc:'Earn at least one badge in every game'},
  cg_dedicated:{game:'crabcake',em:'ğŸ®',name:'Dedicated',desc:'Play 10 games total across all games'},
  cg_bughunter:{game:'crabcake',em:'ğŸ›',name:'Bug Hunter',desc:'Reported a bug to help improve Crabcake'},
  cg_bigideas:{game:'crabcake',em:'ğŸ’¡',name:'Big Ideas',desc:'Suggested a new game idea for Crabcake'},
};
const BADGE_KEY='crabcake_badges_v1';
const PLAYS_KEY='crabcake_plays_v1';
function _lb(){try{return JSON.parse(localStorage.getItem(BADGE_KEY)||'{}');}catch{return{};}}
function _sb(d){try{localStorage.setItem(BADGE_KEY,JSON.stringify(d));}catch{}}
function _lp(){try{return JSON.parse(localStorage.getItem(PLAYS_KEY)||'{}');}catch{return{};}}
function _sp(d){try{localStorage.setItem(PLAYS_KEY,JSON.stringify(d));}catch{}}
function _award(id){const d=_lb();if(d[id])return false;d[id]={earned:true,date:new Date().toLocaleDateString()};_sb(d);return true;}
function _incPlays(game){const p=_lp();p[game]=(p[game]||0)+1;p._total=(p._total||0)+1;_sp(p);return p;}
let _tq=[],_tb=false;
function _toast(id){_tq.push(id);if(!_tb)_nxt();}
function _nxt(){
  if(!_tq.length){_tb=false;return;}_tb=true;
  const id=_tq.shift();const b=BADGE_DEF[id];if(!b){_nxt();return;}
  let t=document.getElementById('_bgt');
  if(!t){t=document.createElement('div');t.id='_bgt';t.className='badge-toast';
    t.innerHTML='<div class="badge-toast-em" id="_bge"></div><div class="badge-toast-text"><div class="badge-toast-label">ğŸ† Badge Unlocked!</div><div class="badge-toast-name" id="_bgn"></div><div class="badge-toast-desc" id="_bgd"></div></div>';
    document.body.appendChild(t);}
  document.getElementById('_bge').textContent=b.em;
  document.getElementById('_bgn').textContent=b.name;
  document.getElementById('_bgd').textContent=b.desc;
  t.classList.add('show');
  setTimeout(()=>{t.classList.remove('show');setTimeout(_nxt,500);},3500);
}
function _crossCheck(ne){
  const p=_lp();
  const games=['mathdive','junglewords','witchbrew','tubesort'];
  if(!_lb().cg_fan&&games.every(g=>(p[g]||0)>=1)){if(_award('cg_fan'))ne.push('cg_fan');}
  const d=_lb();
  const gm={mathdive:false,junglewords:false,witchbrew:false,tubesort:false};
  Object.keys(BADGE_DEF).forEach(id=>{const b=BADGE_DEF[id];if(b.game!=='crabcake'&&d[id])gm[b.game]=true;});
  if(!d.cg_allround&&Object.values(gm).every(Boolean)){if(_award('cg_allround'))ne.push('cg_allround');}
  const d2=_lb();
  if(!d2.cg_dedicated&&(p._total||0)>=10){if(_award('cg_dedicated'))ne.push('cg_dedicated');}
}
function _renderEndBadges(ne){
  const wrap=document.getElementById('goBadgesWrap');
  const row=document.getElementById('goBadgesRow');
  if(!wrap||!row)return;
  const all=Object.keys(_lb());
  if(!all.length&&!ne.length){wrap.style.display='none';return;}
  wrap.style.display='';
  const title=wrap.querySelector('.badges-section-title');
  if(title)title.textContent=ne.length?`ğŸ† Badge${ne.length>1?'s':''} Earned This Game!`:'ğŸ† Your Badges';
  const show=ne.length?ne:all.slice(0,6);
  row.innerHTML=show.map(id=>{const b=BADGE_DEF[id];if(!b)return'';
    return`<div class="badge-coin${ne.includes(id)?' new-badge':''}" title="${b.desc}"><div class="badge-coin-em">${b.em}</div><div class="badge-coin-name">${b.name}</div></div>`;
  }).join('');
}

// â”€â”€ Witch's Brew: award badges inline (during play) + at end â”€â”€
let _wbGameBadges = [];
function _wbCheckMidGame(recipe) {
  // Called on each successful brew
  const ne = [];
  if (_award('wb_first')) ne.push('wb_first');
  if (recipe.r === 'rare' && _award('wb_rare')) ne.push('wb_rare');
  if (recipe.r === 'epic' && _award('wb_epic')) ne.push('wb_epic');
  if (recipe.r === 'legendary' && _award('wb_legend')) ne.push('wb_legend');
  if (discovered.size >= 10 && _award('wb_collect')) ne.push('wb_collect');
  if (streak >= 3 && _award('wb_streak')) ne.push('wb_streak');
  ne.forEach(id => { _toast(id); _wbGameBadges.push(id); });
}
function awardWitchBrewEndBadges() {
  const ne = [...new Set(_wbGameBadges)];
  _incPlays('witchbrew');
  _crossCheck(ne);
  ne.forEach(id => { if(!_wbGameBadges.includes(id)) _toast(id); });
  setTimeout(() => _renderEndBadges(ne), 600);
  _wbGameBadges = [];
}

// â”€â”€ Feedback badge claim â”€â”€
function showClaim(type) {
  setTimeout(() => {
    const el = document.getElementById('feedback-claim-' + type);
    if (el) el.style.display = 'block';
  }, 800);
}
function claimFeedbackBadge(type) {
  const id = type === 'bug' ? 'cg_bughunter' : 'cg_bigideas';
  const btn = document.querySelector(`#feedback-claim-${type} .feedback-claim-btn`);
  if (_award(id)) {
    _toast(id);
    if (btn) { btn.textContent = 'ğŸ† Badge earned!'; btn.disabled = true; }
  } else {
    if (btn) { btn.textContent = 'âœ… Already earned!'; btn.disabled = true; }
  }
}

function init(){
  renderIng();
  renderBook();
  renderLB();
  updateHud();

  // Book filter
  document.getElementById('bfilter').addEventListener('click',e=>{
    const b=e.target.closest('.fbtn');if(!b)return;
    document.querySelectorAll('.fbtn').forEach(x=>x.classList.remove('on'));
    b.classList.add('on');curFilter=b.dataset.f;renderBook();
  });

  // Brew button
  document.getElementById('brew-btn').addEventListener('click',()=>{
    if(sel.length<3) return;
    document.getElementById('brew-btn').disabled=true;
    playSound('brew');
    brewSwirlEffect(()=>{
      updateCauldronSlots(); // slots clear visually
      brew();
    });
    // Clear slots visually mid-swirl
    setTimeout(()=>{
      for(let i=0;i<3;i++){
        const s=document.getElementById('cslot-'+i);
        if(s){s.classList.remove('filled','empty-slot');s.classList.add('empty-slot');s.querySelector('.cslot-em').textContent='';}
      }
    },300);
  });

  // Close result â€” cancel auto-close when manually dismissed
  document.getElementById('close-btn').addEventListener('click',()=>{
    cancelResAutoClose();
    document.getElementById('res-ovl').classList.remove('show');
    clearCauldron();
    if(triesLeft<=0)endGame();
  });

  // Save score
  document.getElementById('save-btn').addEventListener('click',()=>{
    const name=(document.getElementById('player-name').value.trim()||'Anonymous Witch');
    addLBEntry(name,score,discovered.size,bestStreak);
    document.getElementById('save-btn').textContent='âœ… Saved!';
    document.getElementById('save-btn').disabled=true;
  });

  // Play again (from game over modal)
  document.getElementById('again-btn').addEventListener('click',resetGame);

  // New Game button â€” confirm then reset
  document.getElementById('new-game-btn').addEventListener('click',()=>{
    document.getElementById('confirm-ovl').classList.add('show');
  });
  document.getElementById('confirm-yes-btn').addEventListener('click',resetGame);
  document.getElementById('confirm-no-btn').addEventListener('click',()=>{
    document.getElementById('confirm-ovl').classList.remove('show');
  });

  // Background bubbles
  setInterval(()=>{
    if(sel.length){
      const id=sel[Math.floor(Math.random()*sel.length)];
      const ing=ING.find(x=>x.id===id);
      if(ing)addBub(ing.col);
    } else {
      addBub('#39ff14');
    }
  },800);
}

init();
</script>
<script src="crabcake-avatar.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function(){
  var hudEl = document.getElementById("potion-avatar-hud");
  if(hudEl) CrabcakeAvatar.injectHUD(hudEl, {size:38, showPet:true});
});
</script>


</body>
</html>
